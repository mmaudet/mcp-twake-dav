---
phase: 10-contact-write-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tools/contacts/delete-contact.ts
  - src/tools/contacts/create-contact.ts
autonomous: true

must_haves:
  truths:
    - "delete_contact tool module exists and exports registerDeleteContactTool"
    - "create_contact tool module exists and exports registerCreateContactTool"
    - "delete_contact finds contact by UID, deletes via addressBookService, handles ConflictError"
    - "create_contact builds vCard via buildVCardString, creates via addressBookService, handles ConflictError"
    - "Both tool descriptions include IMPORTANT confirmation instruction"
  artifacts:
    - path: "src/tools/contacts/delete-contact.ts"
      provides: "delete_contact MCP tool registration"
      exports: ["registerDeleteContactTool"]
      contains: "IMPORTANT"
    - path: "src/tools/contacts/create-contact.ts"
      provides: "create_contact MCP tool registration"
      exports: ["registerCreateContactTool"]
      contains: "IMPORTANT"
  key_links:
    - from: "src/tools/contacts/delete-contact.ts"
      to: "src/caldav/addressbook-service.ts"
      via: "addressBookService.findContactByUid + addressBookService.deleteContact"
      pattern: "addressBookService\\.findContactByUid|addressBookService\\.deleteContact"
    - from: "src/tools/contacts/create-contact.ts"
      to: "src/transformers/contact-builder.ts"
      via: "buildVCardString import and call"
      pattern: "buildVCardString"
    - from: "src/tools/contacts/create-contact.ts"
      to: "src/caldav/addressbook-service.ts"
      via: "addressBookService.createContact"
      pattern: "addressBookService\\.createContact"
---

<objective>
Create the delete_contact and create_contact MCP tool modules for Phase 10 (Contact Write Tools).

Purpose: These are the two simpler contact write tools (no parse-modify-serialize complexity). They follow the exact pattern established by Phase 9's delete_event.ts and create_event.ts, adapted for contacts (AddressBookService instead of CalendarService, vCard instead of iCalendar).

Output: Two new tool modules ready for registration in Plan 02.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references (read these FIRST to understand the exact pattern)
@src/tools/calendar/delete-event.ts
@src/tools/calendar/create-event.ts

# Contact infrastructure (already exists)
@src/caldav/addressbook-service.ts
@src/transformers/contact-builder.ts
@src/types/dtos.ts
@src/errors.ts

# Existing contact tool pattern (for imports, param naming)
@src/tools/contacts/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create delete_contact tool module</name>
  <files>src/tools/contacts/delete-contact.ts</files>
  <action>
Create `src/tools/contacts/delete-contact.ts` by adapting `src/tools/calendar/delete-event.ts` for contacts.

**Function signature:**
```typescript
export function registerDeleteContactTool(
  server: McpServer,
  addressBookService: AddressBookService,
  logger: Logger,
  defaultAddressBook?: string,
): void
```

**Tool registration:**
- Name: `delete_contact`
- Description: `Delete a contact by its UID. Removes the contact from the CardDAV server permanently. IMPORTANT: Confirm with the user before proceeding.`
- Parameters:
  - `uid` (z.string(), required): `The UID of the contact to delete. Use search_contacts to find contact UIDs.`
  - `addressbook` (z.string().optional()): `Address book name to search in. Use "all" to search all address books. Defaults to "${defaultAddressBook}" or all address books.`

**Handler logic (mirror delete-event.ts exactly):**
1. Log debug params
2. Resolve target addressbook: `params.addressbook === 'all' ? undefined : (params.addressbook || defaultAddressBook || undefined)`
3. Find contact by UID: `addressBookService.findContactByUid(params.uid, resolvedAddressBook)`
4. If not found: return `{ content: [{ type: 'text' as const, text: 'Contact not found with UID: ...' }], isError: true }`
5. Build response: `Contact deleted successfully: ${contact.name.formatted || 'Unknown'}` (contacts use `contact.name.formatted` instead of `event.summary`)
6. NO attendee warning (contacts don't have attendees -- skip this part from delete-event.ts)
7. Delete: `await addressBookService.deleteContact(contact.url, contact.etag)`
8. Log info
9. Return success content
10. Catch: ConflictError -> return message with isError. Other errors -> return generic message with isError.

**Key differences from delete-event.ts:**
- Import AddressBookService instead of CalendarService
- Import ConflictError from errors.ts (same)
- No attendee check/warning (contacts don't have attendees)
- Use `contact.name.formatted || 'Unknown'` instead of `event.summary` for display name
- Use `addressbook` parameter name (not `calendar`)
- Use `defaultAddressBook` (not `defaultCalendar`)
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Verify the file exports `registerDeleteContactTool` function.</verify>
  <done>File exists at src/tools/contacts/delete-contact.ts, exports registerDeleteContactTool, compiles cleanly, description contains "IMPORTANT", uses addressBookService.findContactByUid and addressBookService.deleteContact, handles ConflictError.</done>
</task>

<task type="auto">
  <name>Task 2: Create create_contact tool module</name>
  <files>src/tools/contacts/create-contact.ts</files>
  <action>
Create `src/tools/contacts/create-contact.ts` by adapting `src/tools/calendar/create-event.ts` for contacts.

**Function signature:**
```typescript
export function registerCreateContactTool(
  server: McpServer,
  addressBookService: AddressBookService,
  logger: Logger,
  defaultAddressBook?: string,
): void
```

**Tool registration:**
- Name: `create_contact`
- Description: `Create a new contact. IMPORTANT: Confirm with the user before proceeding. Summarize the contact details (name, email, phone, organization) and ask the user to confirm before creating.`
- Parameters:
  - `name` (z.string(), required): `Contact full name (e.g., "Jean Dupont")`
  - `email` (z.string().optional()): `Email address`
  - `phone` (z.string().optional()): `Phone number`
  - `organization` (z.string().optional()): `Organization/company name`
  - `addressbook` (z.string().optional()): `Address book name to create the contact in. Defaults to "${defaultAddressBook}" or first address book.`

**Handler logic (simpler than create-event.ts -- NO chrono-node date parsing needed):**
1. Log debug params
2. Resolve target addressbook: `params.addressbook || defaultAddressBook`
3. Build vCard string: `buildVCardString({ name: params.name, email: params.email, phone: params.phone, organization: params.organization })`
4. Create contact: `await addressBookService.createContact(vCardString, resolvedAddressBook)`
5. Format success response with all provided fields:
   ```
   Contact created successfully [in address book "X"]:
   Name: Jean Dupont
   Email: jean@example.com
   Phone: +33 1 23 45
   Organization: ACME Corp

   Contact URL: https://...
   ```
   Only show lines for fields that were provided. Use `.filter(line => line !== '').join('\n')` pattern from create-event.ts.
6. Log info
7. Return success content
8. Catch: ConflictError -> return message with isError. Other errors -> return generic message with isError.

**Key differences from create-event.ts:**
- Import AddressBookService instead of CalendarService
- Import buildVCardString from contact-builder.ts (not buildICalString from event-builder.ts)
- NO chrono-node import (contacts don't have dates)
- NO date parsing logic (entire start/end date section eliminated)
- NO end-after-start validation
- NO allDay or recurrence parameters
- Parameters: name (required), email, phone, organization, addressbook
- Use `addressbook` parameter (not `calendar`)
- Use `defaultAddressBook` (not `defaultCalendar`)
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Verify the file exports `registerCreateContactTool` function.</verify>
  <done>File exists at src/tools/contacts/create-contact.ts, exports registerCreateContactTool, compiles cleanly, description contains "IMPORTANT", uses buildVCardString and addressBookService.createContact, handles ConflictError, has NO chrono-node import.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (both new files compile)
2. Both files export their register functions
3. Both tool descriptions contain "IMPORTANT"
4. delete-contact uses findContactByUid + deleteContact
5. create-contact uses buildVCardString + createContact
6. Neither file imports chrono-node (contacts don't need date parsing)
7. Both handle ConflictError with isError: true
</verification>

<success_criteria>
- Two new files exist: src/tools/contacts/delete-contact.ts, src/tools/contacts/create-contact.ts
- TypeScript compilation passes with no errors
- Both follow the established Phase 9 patterns adapted for contacts
- Both tool descriptions instruct AI to confirm with user before proceeding
- No new dependencies introduced
</success_criteria>

<output>
After completion, create `.planning/phases/10-contact-write-tools/10-01-SUMMARY.md`
</output>
