---
phase: 10-contact-write-tools
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/tools/contacts/update-contact.ts
  - src/tools/index.ts
  - tests/integration/tools.test.ts
autonomous: true

must_haves:
  truths:
    - "update_contact tool module exists and exports registerUpdateContactTool"
    - "update_contact finds contact by UID, validates at least one field, applies parse-modify-serialize via updateVCardString, updates via addressBookService"
    - "update_contact tool description includes IMPORTANT confirmation instruction"
    - "All 3 contact write tools are registered in src/tools/index.ts"
    - "Integration tests expect 15 tools (was 12) and include all 3 contact write tool names"
    - "All 3 contact write tool descriptions contain IMPORTANT"
  artifacts:
    - path: "src/tools/contacts/update-contact.ts"
      provides: "update_contact MCP tool registration"
      exports: ["registerUpdateContactTool"]
      contains: "IMPORTANT"
    - path: "src/tools/index.ts"
      provides: "Registration hub for all 15 MCP tools"
      contains: "registerDeleteContactTool"
    - path: "tests/integration/tools.test.ts"
      provides: "Integration tests for 15 tools"
      contains: "15"
  key_links:
    - from: "src/tools/contacts/update-contact.ts"
      to: "src/caldav/addressbook-service.ts"
      via: "addressBookService.findContactByUid + addressBookService.updateContact"
      pattern: "addressBookService\\.findContactByUid|addressBookService\\.updateContact"
    - from: "src/tools/contacts/update-contact.ts"
      to: "src/transformers/contact-builder.ts"
      via: "updateVCardString import and call"
      pattern: "updateVCardString"
    - from: "src/tools/index.ts"
      to: "src/tools/contacts/delete-contact.ts"
      via: "import registerDeleteContactTool"
      pattern: "registerDeleteContactTool"
    - from: "src/tools/index.ts"
      to: "src/tools/contacts/create-contact.ts"
      via: "import registerCreateContactTool"
      pattern: "registerCreateContactTool"
    - from: "src/tools/index.ts"
      to: "src/tools/contacts/update-contact.ts"
      via: "import registerUpdateContactTool"
      pattern: "registerUpdateContactTool"
---

<objective>
Create the update_contact MCP tool, wire all 3 contact write tools into the registration hub, and update integration tests to expect 15 tools.

Purpose: Completes Phase 10 by delivering the most complex contact write tool (update with parse-modify-serialize) and connecting all 3 tools to the MCP server. Mirrors Phase 9 Plan 02 structure exactly.

Output: Fully wired contact write tools (create, update, delete) registered and integration-tested.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-contact-write-tools/10-01-SUMMARY.md

# Pattern references (read these FIRST to understand the exact pattern)
@src/tools/calendar/update-event.ts
@src/tools/index.ts
@tests/integration/tools.test.ts

# Contact infrastructure (already exists)
@src/caldav/addressbook-service.ts
@src/transformers/contact-builder.ts
@src/types/dtos.ts
@src/errors.ts

# Plan 01 outputs (created in previous plan)
@src/tools/contacts/delete-contact.ts
@src/tools/contacts/create-contact.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create update_contact tool module</name>
  <files>src/tools/contacts/update-contact.ts</files>
  <action>
Create `src/tools/contacts/update-contact.ts` by adapting `src/tools/calendar/update-event.ts` for contacts.

**Function signature:**
```typescript
export function registerUpdateContactTool(
  server: McpServer,
  addressBookService: AddressBookService,
  logger: Logger,
  defaultAddressBook?: string,
): void
```

**Tool registration:**
- Name: `update_contact`
- Description: `Update an existing contact by UID. Modifies only the specified fields while preserving all other properties (photos, groups, custom fields). IMPORTANT: Confirm with the user before proceeding. Show the user what will change and ask them to confirm before updating.`
- Parameters:
  - `uid` (z.string(), required): `The UID of the contact to update. Use search_contacts to find contact UIDs.`
  - `name` (z.string().optional()): `New full name (updates both formatted name and structured name components)`
  - `email` (z.string().optional()): `New email address (replaces first email or adds if none exists)`
  - `phone` (z.string().optional()): `New phone number (replaces first phone or adds if none exists)`
  - `organization` (z.string().optional()): `New organization/company name`
  - `addressbook` (z.string().optional()): `Address book name to search in. Use "all" to search all address books. Defaults to "${defaultAddressBook}" or all address books.`

**Handler logic (significantly simpler than update-event.ts):**
1. Log debug params
2. Check at least one updatable field provided (name, email, phone, organization). If none: return error `No changes specified. Provide at least one field to update (name, email, phone, organization).`
3. Resolve target addressbook: `params.addressbook === 'all' ? undefined : (params.addressbook || defaultAddressBook || undefined)`
4. Find contact by UID: `await addressBookService.findContactByUid(params.uid, resolvedAddressBook)`
5. If not found: return error `Contact not found with UID: ${params.uid}`
6. Build changes object (only include defined fields):
   ```typescript
   const changes: { name?: string; email?: string; phone?: string; organization?: string } = {};
   if (params.name !== undefined) changes.name = params.name;
   if (params.email !== undefined) changes.email = params.email;
   if (params.phone !== undefined) changes.phone = params.phone;
   if (params.organization !== undefined) changes.organization = params.organization;
   ```
7. Apply parse-modify-serialize: `const updatedVCardString = updateVCardString(contact._raw, changes);`
8. NO RRULE safety check (contacts don't have RRULE -- skip this entire section from update-event.ts)
9. NO attendee warning (contacts don't have attendees -- skip)
10. Update contact: `await addressBookService.updateContact(contact.url, updatedVCardString, contact.etag!)`
11. Build changed fields list for response (same pattern as update-event.ts):
    ```typescript
    const changedFields: string[] = [];
    if (params.name !== undefined) changedFields.push(`name: "${params.name}"`);
    if (params.email !== undefined) changedFields.push(`email: "${params.email}"`);
    if (params.phone !== undefined) changedFields.push(`phone: "${params.phone}"`);
    if (params.organization !== undefined) changedFields.push(`organization: "${params.organization}"`);
    ```
12. Response: `Contact updated successfully: ${contact.name.formatted || 'Unknown'}\nChanges: ${changedFields.join(', ')}`
13. Log info
14. Return success content
15. Catch: ConflictError -> return message with isError. Other errors -> return generic message with isError.

**Key differences from update-event.ts:**
- Import AddressBookService instead of CalendarService
- Import updateVCardString from contact-builder.ts (not updateICalString from event-builder.ts)
- NO chrono-node import (no date parsing)
- NO ICAL import (no RRULE verification)
- NO date parsing section (entire start/end date parsing eliminated)
- NO start-after-end validation
- NO RRULE safety check
- NO attendee warning
- Parameters: uid (required), name, email, phone, organization, addressbook (all optional except uid)
- Use `addressbook` parameter (not `calendar`)
- Use `contact.name.formatted` for display name (not `event.summary`)
- Use `contact._raw` (not `event._raw`)
- Use `contact.etag!` (not `event.etag!`)
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Verify the file exports `registerUpdateContactTool` function.</verify>
  <done>File exists at src/tools/contacts/update-contact.ts, exports registerUpdateContactTool, compiles cleanly, description contains "IMPORTANT", uses updateVCardString and addressBookService.findContactByUid + updateContact, handles ConflictError, validates at least one field provided, has NO chrono-node or ICAL imports.</done>
</task>

<task type="auto">
  <name>Task 2: Wire all 3 contact write tools into index.ts and update integration tests</name>
  <files>src/tools/index.ts, tests/integration/tools.test.ts</files>
  <action>
**Part A: Update src/tools/index.ts**

1. Add 3 new imports at the top (after the existing contact tool imports):
   ```typescript
   import { registerDeleteContactTool } from './contacts/delete-contact.js';
   import { registerCreateContactTool } from './contacts/create-contact.js';
   import { registerUpdateContactTool } from './contacts/update-contact.js';
   ```

2. Add registration calls AFTER the existing contact query tool registrations (after `registerListContactsTool`) and BEFORE the `list_addressbooks` inline tool. Add a comment block:
   ```typescript
   // Register contact write tools (Phase 10)
   registerDeleteContactTool(server, addressBookService, logger, defaultAddressBook);
   registerCreateContactTool(server, addressBookService, logger, defaultAddressBook);
   registerUpdateContactTool(server, addressBookService, logger, defaultAddressBook);
   ```

3. Update the module JSDoc comment to mention Phase 10:
   ```
   * Registers all calendar query tools (Phase 4), contact query tools (Phase 5),
   * calendar write tools (Phase 9), and contact write tools (Phase 10).
   ```

4. Update the function JSDoc to include Phase 10:
   ```
   * Phase 10: Registers contact write tools (CONW-01 through CONW-03)
   ```

**Part B: Update tests/integration/tools.test.ts**

1. Update the tool count test: change `toHaveLength(12)` to `toHaveLength(15)` in the "should register all 12 tools" test. Also update the test description to "should register all 15 tools".

2. Update the expected tool names array: add `'create_contact'`, `'delete_contact'`, `'update_contact'` to the sorted expectedNames array (insert in alphabetical position).

3. Add 3 new test cases for contact write tool schemas:

   a. **create_contact schema test:**
   ```typescript
   it('should register create_contact with required name and optional fields', async () => {
     const response = await client.listTools();
     const tool = response.tools.find((t) => t.name === 'create_contact');
     expect(tool).toBeDefined();
     expect(tool!.inputSchema).toBeDefined();
     expect(tool!.inputSchema.properties).toBeDefined();
     const properties = tool!.inputSchema.properties!;
     expect('name' in properties).toBe(true);
     expect(tool!.inputSchema.required).toBeDefined();
     expect(tool!.inputSchema.required).toContain('name');
     // Optional fields
     expect('email' in properties).toBe(true);
     expect('phone' in properties).toBe(true);
     expect('organization' in properties).toBe(true);
     expect('addressbook' in properties).toBe(true);
   });
   ```

   b. **update_contact schema test:**
   ```typescript
   it('should register update_contact with required uid and optional fields', async () => {
     const response = await client.listTools();
     const tool = response.tools.find((t) => t.name === 'update_contact');
     expect(tool).toBeDefined();
     expect(tool!.inputSchema).toBeDefined();
     expect(tool!.inputSchema.properties).toBeDefined();
     const properties = tool!.inputSchema.properties!;
     expect('uid' in properties).toBe(true);
     expect(tool!.inputSchema.required).toBeDefined();
     expect(tool!.inputSchema.required).toContain('uid');
     // Optional fields
     expect('name' in properties).toBe(true);
     expect('email' in properties).toBe(true);
     expect('phone' in properties).toBe(true);
     expect('organization' in properties).toBe(true);
   });
   ```

   c. **delete_contact schema test:**
   ```typescript
   it('should register delete_contact with required uid and optional addressbook', async () => {
     const response = await client.listTools();
     const tool = response.tools.find((t) => t.name === 'delete_contact');
     expect(tool).toBeDefined();
     expect(tool!.inputSchema).toBeDefined();
     expect(tool!.inputSchema.properties).toBeDefined();
     const properties = tool!.inputSchema.properties!;
     expect('uid' in properties).toBe(true);
     expect(tool!.inputSchema.required).toBeDefined();
     expect(tool!.inputSchema.required).toContain('uid');
     expect('addressbook' in properties).toBe(true);
   });
   ```

4. Update the confirmation instruction test to include contact write tools:
   Change the `writeToolNames` array from `['create_event', 'update_event', 'delete_event']` to `['create_event', 'update_event', 'delete_event', 'create_contact', 'update_contact', 'delete_contact']`.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify TypeScript compiles without errors
2. Run `npx vitest run tests/integration/tools.test.ts` to verify all integration tests pass (including new tests for 15 tools)
  </verify>
  <done>
- src/tools/index.ts imports and registers all 3 contact write tools (15 total tools)
- tests/integration/tools.test.ts expects 15 tools, includes create_contact/update_contact/delete_contact in expectedNames
- All integration tests pass
- Confirmation instruction test covers all 6 write tools (3 calendar + 3 contact)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (all files compile)
2. `npx vitest run tests/integration/tools.test.ts` passes (15 tools registered, all schema tests pass)
3. update-contact.ts uses updateVCardString + addressBookService.findContactByUid + updateContact
4. update-contact.ts validates at least one field provided
5. update-contact.ts does NOT import chrono-node or ICAL (contacts don't need date parsing or RRULE)
6. index.ts registers all 3 contact write tools with correct parameters
7. All 6 write tool descriptions contain "IMPORTANT"
8. `npm run build` succeeds (if build script exists)
</verification>

<success_criteria>
- update_contact tool created with parse-modify-serialize pattern
- All 3 contact write tools wired into src/tools/index.ts
- Integration tests updated to expect 15 tools
- All tests pass
- All 6 write tool descriptions include confirmation instruction
- Phase 10 requirements CONW-01, CONW-02, CONW-03, WINF-05 (contact part) fully implemented
</success_criteria>

<output>
After completion, create `.planning/phases/10-contact-write-tools/10-02-SUMMARY.md`
</output>
