---
phase: 05-contact-query-services
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/tools/contacts/search.ts
  - src/tools/contacts/details.ts
  - src/tools/contacts/list.ts
  - src/tools/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can search contacts by name with partial, case-insensitive match (CON-01)"
    - "User can get full details for a specific contact by name (CON-02)"
    - "User can list contacts from their address books with 30-contact limit (CON-03)"
    - "User can list available address books (CON-04)"
    - "Contact search supports optional organization parameter for workplace queries"
    - "All 4 contact tools are registered before server.connect()"
    - "registerAllTools accepts AddressBookService as additional parameter"
  artifacts:
    - path: "src/tools/contacts/search.ts"
      provides: "search_contacts MCP tool (CON-01)"
      exports: ["registerSearchContactsTool"]
      min_lines: 40
    - path: "src/tools/contacts/details.ts"
      provides: "get_contact_details MCP tool (CON-02)"
      exports: ["registerGetContactDetailsTool"]
      min_lines: 40
    - path: "src/tools/contacts/list.ts"
      provides: "list_contacts MCP tool (CON-03)"
      exports: ["registerListContactsTool"]
      min_lines: 40
    - path: "src/tools/index.ts"
      provides: "Updated aggregator registering calendar + contact tools"
      exports: ["registerAllTools"]
    - path: "src/index.ts"
      provides: "Updated entry point passing addressBookService to registerAllTools"
  key_links:
    - from: "src/tools/contacts/search.ts"
      to: "src/tools/contacts/utils.ts"
      via: "imports getAllContacts, searchContactsByName, searchContactsByOrganization, formatContact"
      pattern: "import.*from.*./utils"
    - from: "src/tools/contacts/details.ts"
      to: "src/tools/contacts/utils.ts"
      via: "imports getAllContacts, searchContactsByName, formatContact"
      pattern: "import.*from.*./utils"
    - from: "src/tools/contacts/list.ts"
      to: "src/tools/contacts/utils.ts"
      via: "imports getAllContacts, formatContactSummary"
      pattern: "import.*from.*./utils"
    - from: "src/tools/index.ts"
      to: "src/tools/contacts/search.ts"
      via: "imports registerSearchContactsTool"
      pattern: "import.*registerSearchContactsTool.*from.*contacts/search"
    - from: "src/tools/index.ts"
      to: "src/caldav/addressbook-service.ts"
      via: "AddressBookService type parameter"
      pattern: "import.*AddressBookService.*from.*caldav/addressbook-service"
    - from: "src/index.ts"
      to: "src/tools/index.ts"
      via: "passes addressBookService to registerAllTools"
      pattern: "registerAllTools.*server.*calendarService.*addressBookService.*logger"
---

<objective>
Create 4 contact MCP tools and wire them into the server entry point.

Purpose: Complete Phase 5 by exposing CardDAV contact data through MCP tools, enabling natural language contact queries like "What's Marie's email?" and "List my contacts." This delivers CON-01 through CON-04.

Output: 3 new tool files (search.ts, details.ts, list.ts), updated tools/index.ts (aggregator with AddressBookService), updated src/index.ts (passes addressBookService), and inline list_addressbooks tool (CON-04).
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-contact-query-services/05-RESEARCH.md
@.planning/phases/05-contact-query-services/05-01-SUMMARY.md

# Source files for reference
@src/tools/contacts/utils.ts            — Phase 5 Plan 01 output (shared utils)
@src/tools/calendar/search.ts           — Phase 4 search tool pattern to mirror
@src/tools/index.ts                     — Current aggregator (needs AddressBookService param)
@src/index.ts                           — Current entry point (needs addressBookService pass-through)
@src/caldav/addressbook-service.ts      — AddressBookService with listAddressBooks, fetchContacts, fetchAllContacts
@src/types/dtos.ts                      — ContactDTO type definition
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact MCP tools (search, details, list)</name>
  <files>src/tools/contacts/search.ts, src/tools/contacts/details.ts, src/tools/contacts/list.ts</files>
  <action>
Create 3 contact tool files following Phase 4's search.ts pattern exactly (server.tool with Zod schemas, try/catch, AI-friendly error responses, logging).

**File 1: src/tools/contacts/search.ts (CON-01 + organization queries)**

Export `registerSearchContactsTool(server: McpServer, addressBookService: AddressBookService, logger: Logger): void`

Register tool `search_contacts` with description: "Search contacts by name across all address books. Supports optional organization filter. Case-insensitive partial matching on formatted name, given name, and family name."

Zod parameters:
- `name`: `z.string().optional().describe('Name to search for (case-insensitive, partial match)')`
- `organization`: `z.string().optional().describe('Organization to filter by (case-insensitive, partial match)')`

Handler logic:
1. Require at least one of name or organization (return isError if neither)
2. Call `getAllContacts(addressBookService, logger)` to fetch + transform all contacts
3. If `name` provided: filter with `searchContactsByName(contacts, name)`
4. If `organization` provided: filter with `searchContactsByOrganization(contacts, organization)`
5. If both provided: apply name filter first, then organization filter on results (intersection)
6. If no matches: return "No contacts found matching {criteria}"
7. Format matches with `formatContact()`, join with '\n\n'
8. Return: "Found N contact(s) matching {criteria}:\n\n{formatted}"
9. Wrap in try/catch with error logging and isError: true response

**File 2: src/tools/contacts/details.ts (CON-02)**

Export `registerGetContactDetailsTool(server: McpServer, addressBookService: AddressBookService, logger: Logger): void`

Register tool `get_contact_details` with description: "Get full details for a specific contact by name. Returns detailed contact information including all email addresses, phone numbers, and organization."

Zod parameters:
- `name`: `z.string().describe('Contact name to look up (case-insensitive, partial match)')`

Handler logic:
1. Call `getAllContacts(addressBookService, logger)` to fetch + transform
2. Search with `searchContactsByName(contacts, name)`
3. If no matches: return "No contact found matching {name}"
4. If multiple matches: format ALL matches with `formatContact()` (let user disambiguate)
5. Return header: "Found N contact(s) matching {name}:\n\n{formatted}"
6. For single match: "Contact details for {displayName}:\n\n{formatted}"
7. Wrap in try/catch

This is similar to search_contacts but the tool description signals it's for getting details about a specific person, which helps the LLM route the right queries to it.

**File 3: src/tools/contacts/list.ts (CON-03)**

Export `registerListContactsTool(server: McpServer, addressBookService: AddressBookService, logger: Logger): void`

Register tool `list_contacts` with description: "List all contacts from all address books. Shows a summary of each contact (name, email, organization). Limited to 30 contacts."

Zod parameters: `{}` (empty - no parameters needed)

Handler logic:
1. Call `getAllContacts(addressBookService, logger)` to fetch + transform
2. If empty: return "No contacts found in any address book"
3. Sort contacts alphabetically by display name (formatted name or "given family" fallback)
4. Limit to 30 contacts (truncation protection per research)
5. Format each with `formatContactSummary()` (single-line format for list view)
6. Join with '\n'
7. If truncated: add "\n\n(Showing 30 of {total} contacts. Use search_contacts to find specific contacts.)"
8. Return: "Contacts ({count}):\n\n{formatted}"
9. Wrap in try/catch

**For all 3 files:**
- Use ESM imports with .js extensions
- Import types with `type` keyword where applicable
- Use `'text' as const` for content type (Phase 4 pattern)
- JSDoc comments on exported function
- Logger.debug at entry, logger.info at success, logger.error in catch
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Zero type errors. Verify each file exports its register function.
  </verify>
  <done>
3 contact tool files exist: search.ts (CON-01 with organization param), details.ts (CON-02), list.ts (CON-03). Each registers an MCP tool using server.tool() with Zod schemas, try/catch error handling, and AI-friendly responses. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tool aggregator and entry point wiring</name>
  <files>src/tools/index.ts, src/index.ts</files>
  <action>
Update 2 existing files to wire contact tools into the MCP server.

**File 1: src/tools/index.ts (aggregator update)**

Update `registerAllTools` to accept AddressBookService and register contact tools:

1. Add imports at top:
   - `import type { AddressBookService } from '../caldav/addressbook-service.js';`
   - `import { registerSearchContactsTool } from './contacts/search.js';`
   - `import { registerGetContactDetailsTool } from './contacts/details.js';`
   - `import { registerListContactsTool } from './contacts/list.js';`

2. Change function signature from:
   `registerAllTools(server: McpServer, calendarService: CalendarService, logger: Logger): void`
   to:
   `registerAllTools(server: McpServer, calendarService: CalendarService, addressBookService: AddressBookService, logger: Logger): void`

3. After the existing list_calendars tool registration, replace the `// TODO (Phase 5)` comment with:
   - `registerSearchContactsTool(server, addressBookService, logger);`
   - `registerGetContactDetailsTool(server, addressBookService, logger);`
   - `registerListContactsTool(server, addressBookService, logger);`

4. Add inline `list_addressbooks` tool (CON-04) following the exact list_calendars pattern:
   - Tool name: 'list_addressbooks'
   - Description: 'List all available address books for the authenticated user.'
   - Parameters: `{}` (none)
   - Handler: Call `addressBookService.listAddressBooks()`, format as "displayName\n  URL: url" for each, return count header
   - Same try/catch pattern as list_calendars
   - Handle empty case: "No address books found"

5. Update JSDoc to mention Phase 5 contact tools

**File 2: src/index.ts (entry point update)**

1. Update the `registerAllTools` call (line 59) from:
   `registerAllTools(server, calendarService, logger);`
   to:
   `registerAllTools(server, calendarService, addressBookService, logger);`

2. Replace the `// TODO (Phase 5): Register contact query tools using addressBookService` comment (line 62) with:
   `logger.info('Calendar and contact tools registered');`

3. Remove the existing `logger.info('Calendar tools registered');` (line 60) since the new log message covers both.

CRITICAL: Ensure tools are registered BEFORE `server.connect(transport)`. The existing call site is already before connect, just update the arguments.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Zero type errors. Verify:
1. registerAllTools now accepts 4 parameters (server, calendarService, addressBookService, logger)
2. src/index.ts passes addressBookService to registerAllTools
3. All tool registrations happen before server.connect(transport)
  </verify>
  <done>
- src/tools/index.ts: registerAllTools accepts AddressBookService, registers 3 contact tools + inline list_addressbooks (CON-04). TODO comment removed.
- src/index.ts: Passes addressBookService to registerAllTools. TODO comment removed. All 9 MCP tools (5 calendar + 4 contact) registered before server.connect().
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. 9 MCP tools total: get_next_event, get_todays_schedule, get_events_in_range, search_events, list_calendars, search_contacts, get_contact_details, list_contacts, list_addressbooks
3. All tools registered before `server.connect(transport)` in src/index.ts
4. registerAllTools signature includes AddressBookService parameter
5. No TODO comments remaining for Phase 5 in src/tools/index.ts or src/index.ts
6. search_contacts supports both name and organization parameters
7. list_contacts limits to 30 contacts with truncation message
</verification>

<success_criteria>
- 4 contact MCP tools registered: search_contacts (CON-01), get_contact_details (CON-02), list_contacts (CON-03), list_addressbooks (CON-04)
- All tools use Zod schemas, try/catch error handling, AI-friendly responses
- Tools registered before server.connect() for MCP discoverability
- search_contacts handles both name and organization queries
- list_contacts limits to 30 contacts (truncation protection)
- TypeScript compiles with zero errors
- No Phase 5 TODO comments remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/05-contact-query-services/05-02-SUMMARY.md`
</output>
