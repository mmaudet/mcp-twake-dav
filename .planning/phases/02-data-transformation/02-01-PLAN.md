---
phase: 02-data-transformation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/dtos.ts
  - src/transformers/event.ts
  - src/transformers/timezone.ts
autonomous: true

must_haves:
  truths:
    - "iCalendar event string transforms into typed EventDTO with uid, summary, startDate, endDate, location, attendees"
    - "Raw iCalendar text preserved in _raw field on every EventDTO"
    - "Timezone VTIMEZONE components registered before event parsing"
    - "Events with missing UID are rejected with logged warning"
    - "Empty or malformed iCalendar data returns null (not crash)"
  artifacts:
    - path: "src/types/dtos.ts"
      provides: "EventDTO and ContactDTO type definitions"
      exports: ["EventDTO", "ContactDTO"]
      contains: "_raw: string"
    - path: "src/transformers/event.ts"
      provides: "iCalendar VEVENT to EventDTO transformation"
      exports: ["transformCalendarObject"]
      min_lines: 40
    - path: "src/transformers/timezone.ts"
      provides: "VTIMEZONE registration utilities"
      exports: ["registerTimezones"]
  key_links:
    - from: "src/transformers/event.ts"
      to: "src/types/dtos.ts"
      via: "import EventDTO type"
      pattern: "import.*EventDTO.*from.*dtos"
    - from: "src/transformers/event.ts"
      to: "src/transformers/timezone.ts"
      via: "registerTimezones call before event parsing"
      pattern: "registerTimezones"
    - from: "src/transformers/event.ts"
      to: "ical.js"
      via: "ICAL.parse, ICAL.Component, ICAL.Event"
      pattern: "ICAL\\.parse|ICAL\\.Component|ICAL\\.Event"
---

<objective>
Install ical.js, define Event/Contact DTO types, and implement the iCalendar event transformer with timezone support.

Purpose: This is the core data transformation layer. iCalendar data from CalDAV servers must be parsed into typed TypeScript DTOs while preserving raw text for future v2 write operations. Timezone registration must happen BEFORE event parsing to avoid DST-related time errors.

Output: EventDTO/ContactDTO type definitions, working event transformer function, and timezone registration utility.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-transformation/02-RESEARCH.md
@src/config/logger.ts
@src/types/index.ts
@tsconfig.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ical.js and define DTO types</name>
  <files>package.json, src/types/dtos.ts</files>
  <action>
1. Install ical.js: `npm install ical.js`
   - Verify it appears in package.json dependencies
   - NOTE: There is NO @types/ical.js package. ical.js v2.1.0+ ships TypeScript types from JSDoc.

2. Create `src/types/dtos.ts` with EventDTO and ContactDTO interfaces:

   EventDTO fields:
   - uid: string (required, from VEVENT UID)
   - summary: string (required, defaults to "(No title)" if missing)
   - description: string | undefined
   - startDate: Date (from DTSTART converted via toJSDate())
   - endDate: Date (from DTEND converted via toJSDate())
   - location: string | undefined
   - attendees: string[] (CN parameter from ATTENDEE, or email value)
   - timezone: string | undefined (TZID from VTIMEZONE if present)
   - isRecurring: boolean (true if RRULE exists)
   - recurrenceRule: string | undefined (raw RRULE string)
   - url: string (CalDAV object URL from tsdav)
   - etag: string | undefined (from tsdav)
   - _raw: string (CRITICAL: complete original iCalendar text)

   ContactDTO fields:
   - uid: string (required, from vCard UID)
   - name: { formatted?: string; given?: string; family?: string } (from FN and N properties)
   - emails: string[] (from EMAIL properties)
   - phones: string[] (from TEL properties)
   - organization: string | undefined (from ORG property)
   - version: '3.0' | '4.0' (auto-detected from VERSION property)
   - url: string (CardDAV object URL from tsdav)
   - etag: string | undefined (from tsdav)
   - _raw: string (CRITICAL: complete original vCard text)

IMPORTANT:
- Use `.js` extension in any relative imports
- Both DTOs MUST have `_raw: string` field (INF-03 requirement)
- Export both interfaces as named exports
- Do NOT import from `src/types/index.ts` (that file is orphaned, Config comes from schema.ts)
  </action>
  <verify>
1. `npm ls ical.js` shows ical.js installed
2. `npx tsc --noEmit` compiles without errors
3. `grep "_raw: string" src/types/dtos.ts` returns 2 matches (one per DTO)
4. `grep "export interface EventDTO" src/types/dtos.ts` returns 1 match
5. `grep "export interface ContactDTO" src/types/dtos.ts` returns 1 match
  </verify>
  <done>ical.js installed as dependency. EventDTO and ContactDTO interfaces defined with all required fields including _raw preservation. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Implement event transformer with timezone registration</name>
  <files>src/transformers/timezone.ts, src/transformers/event.ts</files>
  <action>
1. Create `src/transformers/timezone.ts`:
   - Export function `registerTimezones(comp: ICAL.Component): void`
   - Extract all VTIMEZONE subcomponents: `comp.getAllSubcomponents('vtimezone')`
   - For each VTIMEZONE, create `new ICAL.Timezone(vtz)` and register with `ICAL.TimezoneService.register(tz)`
   - Log at debug level how many timezones registered (accept Logger parameter)
   - Import ICAL: `import ICAL from 'ical.js';`

2. Create `src/transformers/event.ts`:
   - Import ICAL from 'ical.js'
   - Import EventDTO from '../types/dtos.js'
   - Import registerTimezones from './timezone.js'
   - Import Logger type from 'pino'
   - Import DAVCalendarObject type from 'tsdav'

   Export function `transformCalendarObject(davObject: DAVCalendarObject, logger: Logger): EventDTO | null`

   Implementation:
   a. Guard: if davObject.data is falsy, log warning and return null
   b. Parse: `const jCalData = ICAL.parse(davObject.data)`
   c. Create component: `const comp = new ICAL.Component(jCalData)`
   d. Register timezones FIRST: `registerTimezones(comp, logger)` -- MUST happen before VEVENT access
   e. Get VEVENT: `const vevent = comp.getFirstSubcomponent('vevent')` -- if null, log debug, return null
   f. Wrap in Event: `const event = new ICAL.Event(vevent)`
   g. Validate UID: if `!event.uid`, log error and return null (never throw -- return null for graceful degradation)
   h. Extract attendees: `event.attendees.map(a => a.getParameter('cn') || a.getFirstValue() || '')`
   i. Extract timezone: get first VTIMEZONE's TZID property value, or undefined
   j. Extract recurrence rule: `vevent.getFirstProperty('rrule')?.toICALString()` or undefined
   k. Return EventDTO with all fields mapped, `_raw: davObject.data`

   Wrap entire body in try/catch. On error, log error with url context, return null.

CRITICAL RULES:
- Import with `.js` extensions: `from '../types/dtos.js'`, `from './timezone.js'`
- No console.log anywhere -- use logger parameter
- Never modify UIDs from source data
- davObject.data goes directly into _raw (no transformation)
- Register timezones BEFORE accessing event dates (Pitfall 3 from research)

NOTE on ical.js TypeScript types: Types are generated from JSDoc and may need `as any` casts in some places if ical.js type definitions are incomplete (known issue #723). Use type assertions sparingly and only where compiler complains about valid ical.js API usage.
  </action>
  <verify>
1. `npx tsc --noEmit` compiles without errors
2. `grep "registerTimezones" src/transformers/event.ts` confirms timezone registration call
3. `grep "ICAL.parse" src/transformers/event.ts` confirms ical.js parsing
4. `grep "_raw: davObject.data" src/transformers/event.ts` confirms raw preservation
5. `grep "import.*from.*\\.js" src/transformers/event.ts` confirms .js extensions in imports
6. `grep -r "console.log" src/transformers/` returns no results
  </verify>
  <done>Event transformer function parses iCalendar data into typed EventDTO. Timezone registration happens before event date access. Raw iCalendar text preserved in _raw field. All errors handled gracefully (return null, log context). No console.log contamination.</done>
</task>

</tasks>

<verification>
1. `npm ls ical.js` -- ical.js installed
2. `npx tsc --noEmit` -- no TypeScript errors across all new files
3. `grep -r "console.log\|process.stdout" src/` -- no stdout contamination
4. `grep "_raw" src/types/dtos.ts` -- _raw field present in both DTOs
5. `grep "registerTimezones" src/transformers/event.ts` -- timezone registration wired
6. All imports use `.js` extensions
</verification>

<success_criteria>
- ical.js installed and TypeScript compiles with it
- EventDTO and ContactDTO types defined with _raw field
- transformCalendarObject function accepts DAVCalendarObject, returns EventDTO | null
- Timezone VTIMEZONE registration happens before event parsing
- No stdout contamination (no console.log, no process.stdout)
- All imports use .js extensions (ESM compliance)
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-transformation/02-01-SUMMARY.md`
</output>
