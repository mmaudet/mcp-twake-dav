---
phase: 04-calendar-query-services
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/tools/calendar/next-event.ts
  - src/tools/calendar/today.ts
  - src/tools/calendar/date-range.ts
  - src/tools/calendar/search.ts
  - src/tools/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can ask 'What is my next meeting?' and get the correct next upcoming event (CAL-01)"
    - "User can ask 'What is on my calendar today?' and get all today's events sorted by time (CAL-02)"
    - "User can ask 'What is my schedule this week?' and get events for the date range (CAL-03)"
    - "User can ask 'When is my meeting with Pierre?' and find events by attendee name (CAL-04)"
    - "User can ask 'Show meetings about budget' and find events by keyword in summary/description (CAL-04)"
    - "Recurring daily standup appears on all relevant days within queried range (CAL-07)"
    - "All event times display via toLocaleString (process-local timezone) with event timezone label in parentheses when present (CAL-08)"
    - "MCP tools are registered BEFORE server.connect(transport) in index.ts"
    - "list_calendars tool returns available calendar names"
  artifacts:
    - path: "src/tools/calendar/next-event.ts"
      provides: "registerNextEventTool function (CAL-01)"
      exports: ["registerNextEventTool"]
    - path: "src/tools/calendar/today.ts"
      provides: "registerTodaysScheduleTool function (CAL-02)"
      exports: ["registerTodaysScheduleTool"]
    - path: "src/tools/calendar/date-range.ts"
      provides: "registerDateRangeTool function (CAL-03)"
      exports: ["registerDateRangeTool"]
    - path: "src/tools/calendar/search.ts"
      provides: "registerSearchEventsTool function (CAL-04)"
      exports: ["registerSearchEventsTool"]
    - path: "src/tools/index.ts"
      provides: "registerAllTools aggregator"
      exports: ["registerAllTools"]
    - path: "src/index.ts"
      provides: "Tool registration wired before transport.connect()"
      contains: "registerAllTools"
  key_links:
    - from: "src/tools/calendar/next-event.ts"
      to: "src/tools/calendar/utils.ts"
      via: "import formatEvent, getEventsWithRecurrenceExpansion"
      pattern: "import.*utils\\.js"
    - from: "src/tools/index.ts"
      to: "src/tools/calendar/next-event.ts"
      via: "import registerNextEventTool"
      pattern: "import.*next-event\\.js"
    - from: "src/index.ts"
      to: "src/tools/index.ts"
      via: "import registerAllTools"
      pattern: "import.*registerAllTools.*tools/index\\.js"
    - from: "src/index.ts"
      to: "server.connect(transport)"
      via: "registerAllTools called BEFORE connect"
      pattern: "registerAllTools.*\\n.*server\\.connect"
---

<objective>
Create MCP calendar tools implementing CAL-01 through CAL-04, CAL-07, CAL-08, and wire them into the application entry point.

Purpose: This plan delivers the user-facing MCP tools that enable Claude to query calendar events via natural language. Each tool is a workflow-oriented operation that fetches, transforms, filters, and formats events in a single call (Block Engineering pattern). Tools are registered before transport connection per MCP protocol requirements.

Output: 4 calendar tool files, 1 tool registration aggregator, updated index.ts with tool wiring. All 6 Phase 4 requirements satisfied.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-calendar-query-services/04-RESEARCH.md
@.planning/phases/04-calendar-query-services/04-01-SUMMARY.md

@src/tools/calendar/utils.ts
@src/caldav/calendar-service.ts
@src/types/dtos.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP calendar tool modules and registration aggregator</name>
  <files>
    src/tools/calendar/next-event.ts
    src/tools/calendar/today.ts
    src/tools/calendar/date-range.ts
    src/tools/calendar/search.ts
    src/tools/index.ts
  </files>
  <action>
    Create 4 tool modules + 1 aggregator using the MCP SDK `server.tool()` pattern with Zod input schemas.

    **Each tool module exports a single `register*Tool(server, calendarService, logger)` function** that takes the McpServer instance, CalendarService, and Logger, then calls `server.tool()` to register.

    **Tool parameter types:**
    - `server: McpServer` (from `@modelcontextprotocol/sdk/server/mcp.js`)
    - `calendarService: CalendarService` (from `../../caldav/calendar-service.js`)
    - `logger: Logger` (from `pino`)

    **1. src/tools/calendar/next-event.ts -- `registerNextEventTool` (CAL-01)**
    - Tool name: `"get_next_event"`
    - Description: `"Get the next upcoming calendar event. Returns the soonest event from all calendars."`
    - Input schema: `{ calendar: z.string().optional().describe("Optional: filter by calendar name") }`
    - Handler logic:
      1. Create timeRange: now to +365 days
      2. Call `calendarService.fetchAllEvents(timeRange)`
      3. Transform with `getEventsWithRecurrenceExpansion(rawEvents, timeRange, logger)`
      4. If `calendar` param provided, filter events by matching calendar name (case-insensitive partial match on the CalDAV URL or display name -- note: CalendarService returns DAVCalendarObject which doesn't carry calendar name, so skip calendar filtering in v1 and note in tool description)
      5. Sort by startDate ascending, take first
      6. Return formatted event using `formatEvent()`, or "No upcoming events found" message
    - Note: For v1, skip the calendar filter parameter since DAVCalendarObject doesn't carry calendar display name. Keep the schema param for future use but document it as "not yet implemented".

    **2. src/tools/calendar/today.ts -- `registerTodaysScheduleTool` (CAL-02)**
    - Tool name: `"get_todays_schedule"`
    - Description: `"Get all events scheduled for today, sorted by time."`
    - Input schema: `{}` (no inputs)
    - Handler logic:
      1. Create timeRange: getStartOfDay(now) to getEndOfDay(now)
      2. Fetch + expand with `getEventsWithRecurrenceExpansion`
      3. Sort by startDate ascending
      4. Return formatted list with count header: "Today's schedule (N events):\n\n" + events, or "No events scheduled for today"

    **3. src/tools/calendar/date-range.ts -- `registerDateRangeTool` (CAL-03)**
    - Tool name: `"get_events_in_range"`
    - Description: `"Get calendar events for a date range. Accepts natural language like 'this week', 'next month', 'tomorrow', or specific dates like '2026-02-01 to 2026-02-07'."`
    - Input schema: `{ when: z.string().describe("Date range expression: 'this week', 'next month', 'tomorrow', 'January 15 to January 20', etc.") }`
    - Handler logic:
      1. Parse `when` with `parseNaturalDateRange(when)`
      2. If parse fails, return error message: "Could not understand the date range: '{when}'. Try 'this week', 'next month', 'tomorrow', or a specific date."
      3. Fetch + expand with `getEventsWithRecurrenceExpansion`
      4. Sort by startDate ascending
      5. Return formatted list with range header: "Events for {when} (N total):\n\n" + events, or "No events found for {when}"

    **4. src/tools/calendar/search.ts -- `registerSearchEventsTool` (CAL-04)**
    - Tool name: `"search_events"`
    - Description: `"Search calendar events by keyword in title/description or by attendee name. Searches the next 30 days by default."`
    - Input schema: `{ query: z.string().optional().describe("Keyword to search in event titles and descriptions"), attendee: z.string().optional().describe("Attendee name to filter by"), when: z.string().optional().describe("Date range to search (defaults to next 30 days). Examples: 'this week', 'next month'") }`
    - Handler logic:
      1. Require at least one of query or attendee (if both empty, return "Please provide a search query or attendee name")
      2. Parse `when` with `parseNaturalDateRange` or default to next 30 days
      3. Fetch + expand with `getEventsWithRecurrenceExpansion`
      4. Apply keyword filter with `searchEventsByKeyword` if query provided
      5. Apply attendee filter with `searchEventsByAttendee` if attendee provided
      6. Sort by startDate ascending
      7. Return formatted results with search description

    **5. src/tools/index.ts -- `registerAllTools` aggregator**
    - Also register a `"list_calendars"` tool directly in this file (CAL-05 was done in Phase 3 service layer, but needs MCP tool exposure):
      - Tool name: `"list_calendars"`
      - Description: `"List all available calendars for the authenticated user."`
      - Input schema: `{}` (no inputs)
      - Handler: Call `calendarService.listCalendars()`, format as list of calendar display names with URLs
    - Export: `registerAllTools(server: McpServer, calendarService: CalendarService, logger: Logger): void`
    - This function calls all 4 register*Tool functions + registers list_calendars inline

    **Common patterns for ALL tool handlers:**
    - Wrap handler body in try/catch, return AI-friendly error on failure: `{ content: [{ type: "text" as const, text: "Error: ..." }], isError: true }`
    - Log query parameters at debug level, results at info level
    - Use `{ forwardDate: true }` for all chrono-node date parsing
    - All imports use `.js` extensions (ESM)

    **Zod import:** Use `import { z } from 'zod';`
    **McpServer import:** Use `import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';` -- BUT since `server.tool()` is a method call (not just a type), we need the runtime import. Check if McpServer needs to be a regular import. Actually, the function receives `server` as parameter, so we only need the TYPE for the parameter signature. Use `import type`.
  </action>
  <verify>
    Run: `cd /Users/mmaudet/work/mcp-twake && npx tsc --noEmit`
    Expected: No type errors. All 5 files compile successfully.
  </verify>
  <done>
    - 4 tool files exist with correct server.tool() registrations
    - Tool names: get_next_event, get_todays_schedule, get_events_in_range, search_events, list_calendars
    - All tools have Zod input schemas with .describe() annotations
    - registerAllTools aggregator imports and calls all registration functions
    - Error handling wraps all handlers
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire tool registration into application entry point</name>
  <files>src/index.ts</files>
  <action>
    Modify `src/index.ts` to:

    1. Add import at top: `import { registerAllTools } from './tools/index.js';`

    2. Replace the TODO comment block:
       ```
       // TODO (Phase 4/5): Register MCP tools using calendarService and addressBookService
       logger.info('MCP server initialized');
       ```
       With:
       ```
       // Register calendar query tools (Phase 4: CAL-01 through CAL-08)
       registerAllTools(server, calendarService, logger);
       logger.info('Calendar tools registered');

       // TODO (Phase 5): Register contact query tools using addressBookService
       logger.info('MCP server initialized');
       ```

    CRITICAL: The `registerAllTools(server, ...)` call MUST be AFTER `new McpServer(...)` but BEFORE `server.connect(transport)`. Tools registered after connect are invisible to MCP clients (see 04-RESEARCH.md Pitfall 3).

    Do NOT change any other part of index.ts. Preserve the startup sequence, error handling, and all existing imports.
  </action>
  <verify>
    Run: `cd /Users/mmaudet/work/mcp-twake && npx tsc --noEmit`
    Expected: No type errors.

    Then verify tool registration order:
    Run: `cd /Users/mmaudet/work/mcp-twake && grep -n "registerAllTools\|server.connect" src/index.ts`
    Expected: registerAllTools line number < server.connect line number
  </verify>
  <done>
    - src/index.ts imports registerAllTools from ./tools/index.js
    - registerAllTools called with (server, calendarService, logger)
    - Call is AFTER McpServer creation, BEFORE server.connect(transport)
    - TODO comment updated to reference Phase 5 for contact tools
    - No other changes to index.ts
    - Full build succeeds: `npm run build`
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (zero errors)
2. `npm run build` succeeds (produces build/ output)
3. All 5 tool files exist: next-event.ts, today.ts, date-range.ts, search.ts, src/tools/index.ts
4. src/index.ts calls registerAllTools before server.connect
5. grep confirms 5 MCP tool names registered: get_next_event, get_todays_schedule, get_events_in_range, search_events, list_calendars
6. All tool handlers have try/catch error handling
7. chrono-node used with forwardDate: true in date parsing
8. formatEvent used for all tool responses (timezone-aware)
</verification>

<success_criteria>
- All 6 Phase 4 requirements addressed: CAL-01 (next event), CAL-02 (today), CAL-03 (date range), CAL-04 (search), CAL-07 (recurrence expansion), CAL-08 (timezone display)
- 5 MCP tools registered and discoverable
- Tools registered before transport connection
- Build succeeds without errors
- Tool responses are concise, human-readable text (not JSON dumps)
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-query-services/04-02-SUMMARY.md`
</output>
