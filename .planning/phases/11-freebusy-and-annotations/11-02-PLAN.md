---
phase: 11-freebusy-and-annotations
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/tools/index.ts
  - src/tools/calendar/next-event.ts
  - src/tools/calendar/today.ts
  - src/tools/calendar/date-range.ts
  - src/tools/calendar/search.ts
  - src/tools/calendar/create-event.ts
  - src/tools/calendar/update-event.ts
  - src/tools/calendar/delete-event.ts
  - src/tools/contacts/search.ts
  - src/tools/contacts/details.ts
  - src/tools/contacts/list.ts
  - src/tools/contacts/create-contact.ts
  - src/tools/contacts/update-contact.ts
  - src/tools/contacts/delete-contact.ts
  - src/tools/calendar/check-availability.ts
  - tests/integration/tools.test.ts
autonomous: true

must_haves:
  truths:
    - "All 16 tools are registered and discoverable"
    - "All 9 read tools have readOnlyHint: true annotation"
    - "All 3 create tools have destructiveHint: false, readOnlyHint: false annotations"
    - "All 3 update tools have destructiveHint: true, readOnlyHint: false annotations"
    - "All 3 delete tools have destructiveHint: true, readOnlyHint: false annotations"
    - "check_availability has readOnlyHint: true annotation"
    - "All tools have openWorldHint: true annotation"
    - "Integration tests verify 16 tools and annotations"
  artifacts:
    - path: "src/tools/index.ts"
      provides: "Tool registration hub with 16 tools including check_availability"
      contains: "registerCheckAvailabilityTool"
    - path: "tests/integration/tools.test.ts"
      provides: "Integration tests verifying 16 tools and annotations"
      contains: "check_availability"
  key_links:
    - from: "src/tools/index.ts"
      to: "src/tools/calendar/check-availability.ts"
      via: "import and register call"
      pattern: "registerCheckAvailabilityTool"
    - from: "src/tools/calendar/next-event.ts"
      to: "server.tool 5th parameter"
      via: "annotations object"
      pattern: "readOnlyHint.*true"
    - from: "tests/integration/tools.test.ts"
      to: "all 16 tools"
      via: "tool count and name assertions"
      pattern: "toHaveLength\\(16\\)"
---

<objective>
Add MCP annotations to all 16 tools (read/write/destructive hints) and wire check_availability into the tool registry with updated integration tests.

Purpose: Completes WINF-04 (MCP annotations on all tools) and finishes ADV-01 by registering check_availability. AI clients like Claude Desktop can now distinguish read-only from write/destructive operations.
Output: All 16 tools annotated with proper readOnlyHint/destructiveHint/openWorldHint, check_availability registered, integration tests updated for 16 tools.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-freebusy-and-annotations/11-RESEARCH.md

@src/tools/index.ts
@src/tools/calendar/next-event.ts
@src/tools/calendar/create-event.ts
@src/tools/calendar/check-availability.ts
@tests/integration/tools.test.ts
@src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP annotations to all existing tools + register check_availability</name>
  <files>
    src/tools/calendar/next-event.ts
    src/tools/calendar/today.ts
    src/tools/calendar/date-range.ts
    src/tools/calendar/search.ts
    src/tools/calendar/create-event.ts
    src/tools/calendar/update-event.ts
    src/tools/calendar/delete-event.ts
    src/tools/contacts/search.ts
    src/tools/contacts/details.ts
    src/tools/contacts/list.ts
    src/tools/contacts/create-contact.ts
    src/tools/contacts/update-contact.ts
    src/tools/contacts/delete-contact.ts
    src/tools/calendar/check-availability.ts
    src/tools/index.ts
  </files>
  <action>
**MCP annotations go in the 5th parameter of `server.tool()` as `{ annotations: { ... } }`.**

Research confirmed (11-RESEARCH.md): MCP SDK 1.25.3 supports `server.tool(name, desc, schema, handler, { annotations: {...} })`.

**For each tool file, add the 5th parameter to the `server.tool()` call:**

**Read-only calendar tools (readOnlyHint: true):**

1. `src/tools/calendar/next-event.ts` -- after the handler function closing brace, add:
```typescript
    },  // end of handler
    {
      annotations: {
        readOnlyHint: true,
        destructiveHint: false,
        openWorldHint: true,
      },
    }
  );  // end of server.tool()
```

2. `src/tools/calendar/today.ts` -- same annotation: `{ readOnlyHint: true, destructiveHint: false, openWorldHint: true }`

3. `src/tools/calendar/date-range.ts` -- same annotation: `{ readOnlyHint: true, destructiveHint: false, openWorldHint: true }`

4. `src/tools/calendar/search.ts` -- same annotation: `{ readOnlyHint: true, destructiveHint: false, openWorldHint: true }`

**Calendar write tools:**

5. `src/tools/calendar/create-event.ts` -- annotation: `{ readOnlyHint: false, destructiveHint: false, openWorldHint: true }` (creates, doesn't destroy)

6. `src/tools/calendar/update-event.ts` -- annotation: `{ readOnlyHint: false, destructiveHint: true, openWorldHint: true }` (modifies existing data)

7. `src/tools/calendar/delete-event.ts` -- annotation: `{ readOnlyHint: false, destructiveHint: true, openWorldHint: true }` (permanently removes)

**Read-only contact tools (readOnlyHint: true):**

8. `src/tools/contacts/search.ts` -- annotation: `{ readOnlyHint: true, destructiveHint: false, openWorldHint: true }`

9. `src/tools/contacts/details.ts` -- annotation: `{ readOnlyHint: true, destructiveHint: false, openWorldHint: true }`

10. `src/tools/contacts/list.ts` -- annotation: `{ readOnlyHint: true, destructiveHint: false, openWorldHint: true }`

**Contact write tools:**

11. `src/tools/contacts/create-contact.ts` -- annotation: `{ readOnlyHint: false, destructiveHint: false, openWorldHint: true }`

12. `src/tools/contacts/update-contact.ts` -- annotation: `{ readOnlyHint: false, destructiveHint: true, openWorldHint: true }`

13. `src/tools/contacts/delete-contact.ts` -- annotation: `{ readOnlyHint: false, destructiveHint: true, openWorldHint: true }`

**check_availability tool (Plan 01 created this file with 4 params):**

14. `src/tools/calendar/check-availability.ts` -- Add 5th parameter to existing server.tool() call: `{ annotations: { readOnlyHint: true, destructiveHint: false, openWorldHint: true } }`

**Inline tools in index.ts:**

15. `src/tools/index.ts` -- `list_calendars` inline tool (around line 60-116): Add 5th param `{ annotations: { readOnlyHint: true, destructiveHint: false, openWorldHint: true } }`

16. `src/tools/index.ts` -- `list_addressbooks` inline tool (around line 129-185): Add 5th param `{ annotations: { readOnlyHint: true, destructiveHint: false, openWorldHint: true } }`

**Register check_availability in index.ts:**

In `src/tools/index.ts`:
1. Add import: `import { registerCheckAvailabilityTool } from './calendar/check-availability.js';`
2. Add registration call after the calendar write tools block (after `registerUpdateEventTool`):
```typescript
  // Register check_availability tool (Phase 11)
  registerCheckAvailabilityTool(server, calendarService, logger, defaultCalendar);
```
3. Update the module doc comment to mention Phase 11

**Annotation reference table (for verification):**

| Tool | readOnlyHint | destructiveHint | openWorldHint |
|------|-------------|-----------------|---------------|
| get_next_event | true | false | true |
| get_todays_schedule | true | false | true |
| get_events_in_range | true | false | true |
| search_events | true | false | true |
| create_event | false | false | true |
| update_event | false | true | true |
| delete_event | false | true | true |
| check_availability | true | false | true |
| list_calendars | true | false | true |
| search_contacts | true | false | true |
| get_contact_details | true | false | true |
| list_contacts | true | false | true |
| create_contact | false | false | true |
| update_contact | false | true | true |
| delete_contact | false | true | true |
| list_addressbooks | true | false | true |

IMPORTANT: The 5th parameter structure is `{ annotations: { readOnlyHint: ..., destructiveHint: ..., openWorldHint: ... } }` -- NOT a flat object. The `annotations` wrapper is required.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all 16 tool files compile with the 5th parameter. Check that no TypeScript errors appear about the annotations parameter type.
  </verify>
  <done>
All 16 server.tool() calls have proper 5th-parameter annotations. check_availability is imported and registered in index.ts. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update integration tests for 16 tools and annotations</name>
  <files>
    tests/integration/tools.test.ts
  </files>
  <action>
Update `tests/integration/tools.test.ts` to verify 16 tools (was 15) and add annotation verification.

**Changes:**

1. **Update tool count test** (line ~80-85):
   Change `expect(response.tools).toHaveLength(15);` to `expect(response.tools).toHaveLength(16);`

2. **Update expected tool names array** (line ~91-108):
   Add `'check_availability'` to the sorted `expectedNames` array. Insert it alphabetically between `'create_event'` and `'delete_contact'`:
```typescript
    const expectedNames = [
      'check_availability',
      'create_contact',
      'create_event',
      'delete_contact',
      'delete_event',
      'get_contact_details',
      'get_events_in_range',
      'get_next_event',
      'get_todays_schedule',
      'list_addressbooks',
      'list_calendars',
      'list_contacts',
      'search_contacts',
      'search_events',
      'update_contact',
      'update_event',
    ];
```

3. **Add test for check_availability schema:**
```typescript
  it('should register check_availability with required start, end parameters', async () => {
    const response = await client.listTools();
    const tool = response.tools.find((t) => t.name === 'check_availability');
    expect(tool).toBeDefined();
    expect(tool!.inputSchema).toBeDefined();
    expect(tool!.inputSchema.properties).toBeDefined();
    const properties = tool!.inputSchema.properties!;
    expect('start' in properties).toBe(true);
    expect('end' in properties).toBe(true);
    expect('calendar' in properties).toBe(true);
    expect(tool!.inputSchema.required).toBeDefined();
    expect(tool!.inputSchema.required).toContain('start');
    expect(tool!.inputSchema.required).toContain('end');
  });
```

4. **Add annotation verification tests:**

NOTE: The MCP Client's `listTools()` response includes tool annotations. Check if the `tool` object from `response.tools` has an `annotations` field. The MCP SDK types should include `annotations?: ToolAnnotations` on the tool object.

```typescript
  it('should have readOnlyHint: true on all read tools', async () => {
    const response = await client.listTools();
    const readToolNames = [
      'check_availability',
      'get_contact_details',
      'get_events_in_range',
      'get_next_event',
      'get_todays_schedule',
      'list_addressbooks',
      'list_calendars',
      'list_contacts',
      'search_contacts',
      'search_events',
    ];

    for (const name of readToolNames) {
      const tool = response.tools.find((t) => t.name === name);
      expect(tool).toBeDefined();
      // MCP SDK returns annotations on the tool object
      expect((tool as any).annotations?.readOnlyHint).toBe(true);
    }
  });

  it('should have destructiveHint: false on create tools', async () => {
    const response = await client.listTools();
    const createToolNames = ['create_event', 'create_contact'];

    for (const name of createToolNames) {
      const tool = response.tools.find((t) => t.name === name);
      expect(tool).toBeDefined();
      expect((tool as any).annotations?.readOnlyHint).toBe(false);
      expect((tool as any).annotations?.destructiveHint).toBe(false);
    }
  });

  it('should have destructiveHint: true on update and delete tools', async () => {
    const response = await client.listTools();
    const destructiveToolNames = [
      'update_event', 'delete_event',
      'update_contact', 'delete_contact',
    ];

    for (const name of destructiveToolNames) {
      const tool = response.tools.find((t) => t.name === name);
      expect(tool).toBeDefined();
      expect((tool as any).annotations?.readOnlyHint).toBe(false);
      expect((tool as any).annotations?.destructiveHint).toBe(true);
    }
  });

  it('should have openWorldHint: true on all tools', async () => {
    const response = await client.listTools();

    for (const tool of response.tools) {
      expect((tool as any).annotations?.openWorldHint).toBe(true);
    }
  });
```

NOTE on `(tool as any).annotations`: The MCP SDK `Tool` type may or may not have `annotations` in its type definition. If the SDK types don't include it, use `(tool as any)`. If TypeScript recognizes it, use it directly. Check during implementation.

5. **Update the confirmation instruction test** to include check_availability note: check_availability does NOT need IMPORTANT confirmation (it's read-only), so the existing `writeToolNames` array in that test stays unchanged.

6. **Verify the mock CalendarService still works:** The mock uses `as unknown as CalendarService`, so adding `getAuthHeaders()` to the real CalendarService doesn't break the mock. No changes needed to mock setup.
  </action>
  <verify>
Run `npm test` -- all tests must pass, including the new annotation tests and the updated tool count (16 tools). Check output for any failures.
  </verify>
  <done>
Integration tests verify: 16 tools registered, check_availability has start/end/calendar params, all read tools have readOnlyHint: true, create tools have destructiveHint: false, update/delete tools have destructiveHint: true, all tools have openWorldHint: true. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm test` passes with all new and existing tests
3. All 16 tools have proper annotations
4. check_availability is registered in index.ts
5. Integration tests verify 16 tool count, tool names, schemas, and annotations
6. `npm run build` succeeds
</verification>

<success_criteria>
- All 16 MCP tools have correct annotations (readOnlyHint, destructiveHint, openWorldHint)
- check_availability is registered and discoverable via MCP protocol
- Integration tests updated from 15 to 16 tools with annotation verification
- All tests pass
- Build succeeds
- WINF-04 requirement fully satisfied
- ADV-01 requirement fully satisfied (tool registered + annotations applied)
</success_criteria>

<output>
After completion, create `.planning/phases/11-freebusy-and-annotations/11-02-SUMMARY.md`
</output>
