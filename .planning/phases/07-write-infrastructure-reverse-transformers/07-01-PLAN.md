---
phase: 07-write-infrastructure-reverse-transformers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/errors.ts
  - src/types/dtos.ts
autonomous: true

must_haves:
  truths:
    - "ConflictError can be thrown and caught with an AI-friendly message describing what conflicted and how to retry"
    - "Write input types exist for event creation, event update, contact creation, and contact update"
    - "FreeBusyPeriod and FreeBusyResult DTOs exist for downstream availability queries"
  artifacts:
    - path: "src/errors.ts"
      provides: "ConflictError class with AI-friendly message"
      contains: "class ConflictError extends Error"
    - path: "src/types/dtos.ts"
      provides: "Write input types and FreeBusy DTOs"
      exports: ["CreateEventInput", "UpdateEventInput", "CreateContactInput", "UpdateContactInput", "FreeBusyPeriod", "FreeBusyResult"]
  key_links:
    - from: "src/errors.ts"
      to: "ConflictError"
      via: "named export"
      pattern: "export class ConflictError"
    - from: "src/types/dtos.ts"
      to: "downstream phases 8-11"
      via: "type imports"
      pattern: "export interface (Create|Update)(Event|Contact)Input"
---

<objective>
Add write infrastructure types and error handling that all downstream v2 phases depend on.

Purpose: Phase 8 (service layer), Phase 9 (calendar tools), Phase 10 (contact tools), and Phase 11 (free/busy) all need ConflictError for 412 handling, write input types for function signatures, and FreeBusy DTOs for availability queries. This foundation must exist before any builder or service work begins.

Output: Extended `src/errors.ts` with ConflictError class, extended `src/types/dtos.ts` with write input interfaces and FreeBusy DTOs.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/errors.ts
@src/types/dtos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ConflictError class to errors.ts</name>
  <files>src/errors.ts</files>
  <action>
Add a `ConflictError` class to `src/errors.ts` as a named export. This class is used when a CalDAV/CardDAV server returns HTTP 412 Precondition Failed (ETag mismatch during optimistic concurrency).

Implementation:
- `ConflictError` extends `Error`
- Constructor takes `resourceType: 'event' | 'contact'` and optional `detail?: string`
- Sets `this.name = 'ConflictError'`
- Generates an AI-friendly message following the existing "What went wrong" + "How to fix it" pattern from `formatStartupError`:
  ```
  The {resourceType} was modified by another client since you last read it.

  Fix: Please fetch the latest version and try your changes again.
  {detail if provided}
  ```
- Export the class alongside the existing `formatStartupError` function (do NOT remove or modify existing code)

Why AI-friendly message matters: Claude reads these error messages to decide what to tell the user. The message must clearly explain what happened and what action to take, matching the established pattern in this file.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the file compiles. Verify the class is exported by checking the import works: create a quick grep for `export class ConflictError`.
  </verify>
  <done>ConflictError class exported from src/errors.ts with AI-friendly message template, existing formatStartupError function unchanged, TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add write input types and FreeBusy DTOs to dtos.ts</name>
  <files>src/types/dtos.ts</files>
  <action>
Add the following interfaces to `src/types/dtos.ts` BELOW the existing `EventDTO` and `ContactDTO` interfaces. Do NOT modify existing interfaces.

**CreateEventInput** - parameters for `buildICalString()`:
```typescript
export interface CreateEventInput {
  /** Event title (SUMMARY) */
  title: string;
  /** Start date/time as ISO 8601 string or Date */
  start: string | Date;
  /** End date/time as ISO 8601 string or Date */
  end: string | Date;
  /** Event description (DESCRIPTION) - optional */
  description?: string;
  /** Event location (LOCATION) - optional */
  location?: string;
  /** All-day event flag - when true, DTSTART/DTEND use DATE not DATE-TIME */
  allDay?: boolean;
  /** RRULE string for recurrence (e.g., "FREQ=WEEKLY;BYDAY=MO") - optional */
  recurrence?: string;
  /** Target calendar display name or path - optional, for routing to correct calendar */
  calendar?: string;
}
```

**UpdateEventInput** - parameters for `updateICalString()`:
```typescript
export interface UpdateEventInput {
  /** New title (SUMMARY) - only modified if provided */
  title?: string;
  /** New start date/time - only modified if provided */
  start?: string | Date;
  /** New end date/time - only modified if provided */
  end?: string | Date;
  /** New description - only modified if provided */
  description?: string;
  /** New location - only modified if provided */
  location?: string;
  /** New recurrence rule - only modified if provided */
  recurrence?: string;
}
```

**CreateContactInput** - parameters for `buildVCardString()`:
```typescript
export interface CreateContactInput {
  /** Full display name (FN property, also used to derive N property) */
  name: string;
  /** Email address (EMAIL property) - optional */
  email?: string;
  /** Phone number (TEL property) - optional */
  phone?: string;
  /** Organization (ORG property) - optional */
  organization?: string;
  /** Target addressbook display name or path - optional */
  addressbook?: string;
}
```

**UpdateContactInput** - parameters for `updateVCardString()`:
```typescript
export interface UpdateContactInput {
  /** New display name - updates FN and N properties */
  name?: string;
  /** New email address - replaces first EMAIL or adds new */
  email?: string;
  /** New phone number - replaces first TEL or adds new */
  phone?: string;
  /** New organization - updates ORG property */
  organization?: string;
}
```

**FreeBusyPeriod** - a single busy time range:
```typescript
export interface FreeBusyPeriod {
  /** Start of busy period */
  start: Date;
  /** End of busy period */
  end: Date;
  /** Free/busy type: BUSY, BUSY-TENTATIVE, BUSY-UNAVAILABLE */
  type: string;
}
```

**FreeBusyResult** - aggregated free/busy query result:
```typescript
export interface FreeBusyResult {
  /** Start of the queried time range */
  queryStart: Date;
  /** End of the queried time range */
  queryEnd: Date;
  /** List of busy periods within the range */
  periods: FreeBusyPeriod[];
}
```

IMPORTANT: Preserve all existing JSDoc comments and interfaces exactly as they are. Add new interfaces after the existing ones with clear section comments.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all types compile. Verify all 6 new interfaces are exported by grepping for `export interface` in the file.
  </verify>
  <done>Six new interfaces (CreateEventInput, UpdateEventInput, CreateContactInput, UpdateContactInput, FreeBusyPeriod, FreeBusyResult) exported from src/types/dtos.ts. Existing EventDTO and ContactDTO interfaces unchanged. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/errors.ts` exports both `formatStartupError` (unchanged) and `ConflictError` (new)
3. `src/types/dtos.ts` exports 8 interfaces total: EventDTO, ContactDTO (existing) + 6 new write/FreeBusy types
4. `npm test` still passes (existing integration tests unaffected)
</verification>

<success_criteria>
- ConflictError class exists with AI-friendly message pattern matching existing formatStartupError style
- All 6 write input and FreeBusy interfaces exported with complete JSDoc documentation
- Zero TypeScript compilation errors
- Existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/07-write-infrastructure-reverse-transformers/07-01-SUMMARY.md`
</output>
