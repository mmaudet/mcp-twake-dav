---
phase: 07-write-infrastructure-reverse-transformers
plan: 02
type: tdd
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/transformers/event-builder.ts
  - tests/unit/event-builder.test.ts
autonomous: true

must_haves:
  truths:
    - "buildICalString produces valid iCalendar with PRODID, VERSION, UID, DTSTAMP, VEVENT, and all supplied properties"
    - "updateICalString parses existing iCalendar, modifies only specified properties, and preserves VALARM, X-properties, ATTENDEE, and all unmodified properties"
    - "All-day events use DATE (not DATE-TIME) for DTSTART and DTEND"
    - "Recurrence rules are added as RRULE property when supplied"
    - "Updates increment SEQUENCE and refresh DTSTAMP and LAST-MODIFIED"
  artifacts:
    - path: "src/transformers/event-builder.ts"
      provides: "buildICalString and updateICalString functions"
      exports: ["buildICalString", "updateICalString"]
      min_lines: 80
    - path: "tests/unit/event-builder.test.ts"
      provides: "Unit tests for event builder functions"
      min_lines: 100
  key_links:
    - from: "src/transformers/event-builder.ts"
      to: "src/types/dtos.ts"
      via: "imports CreateEventInput, UpdateEventInput"
      pattern: "import.*CreateEventInput.*UpdateEventInput.*from.*dtos"
    - from: "src/transformers/event-builder.ts"
      to: "ical.js"
      via: "ICAL.Component, ICAL.Event, ICAL.Time, ICAL.Recur"
      pattern: "import ICAL from 'ical\\.js'"
    - from: "tests/unit/event-builder.test.ts"
      to: "src/transformers/event-builder.ts"
      via: "imports buildICalString, updateICalString"
      pattern: "import.*buildICalString.*updateICalString.*from"
---

<objective>
Build iCalendar construction (create) and parse-modify-serialize (update) functions with TDD, producing valid iCalendar output that preserves all properties during round-trips.

Purpose: These functions are the core of write operations for calendar events. `buildICalString` is used by Phase 9's `create_event` tool, and `updateICalString` is used by `update_event`. The update function is the critical path for preventing silent data loss -- the #1 pitfall identified in v2 research.

Output: Working, tested `src/transformers/event-builder.ts` with `buildICalString()` and `updateICalString()` functions.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/transformers/event.ts
@src/types/dtos.ts
@vitest.config.ts
</context>

<feature>
  <name>iCalendar Event Builder (build + update)</name>
  <files>src/transformers/event-builder.ts, tests/unit/event-builder.test.ts</files>
  <behavior>
**buildICalString(input: CreateEventInput): string**

Cases:
- Basic event {title: "Meeting", start: "2025-03-15T14:00:00Z", end: "2025-03-15T15:00:00Z"} -> iCalendar string containing VCALENDAR, VERSION:2.0, PRODID, VEVENT with UID (UUID format), DTSTAMP, SUMMARY:Meeting, DTSTART, DTEND
- With all optional fields {title, start, end, description: "Notes", location: "Room A", recurrence: "FREQ=WEEKLY;BYDAY=MO"} -> iCalendar string also containing DESCRIPTION:Notes, LOCATION:Room A, RRULE:FREQ=WEEKLY;BYDAY=MO
- All-day event {title: "Holiday", start: "2025-03-15", end: "2025-03-16", allDay: true} -> DTSTART;VALUE=DATE:20250315 and DTEND;VALUE=DATE:20250316 (DATE not DATE-TIME)
- Output is parseable by ICAL.parse() without errors (round-trip validation)

**updateICalString(raw: string, changes: UpdateEventInput): string**

Cases:
- Change title only: raw iCalendar with SUMMARY:Old Title + changes {title: "New Title"} -> output has SUMMARY:New Title, all other properties identical
- Preserve VALARM: raw iCalendar with VALARM subcomponent + any change -> output still contains VALARM with all original trigger/action
- Preserve X-properties: raw iCalendar with X-APPLE-STRUCTURED-LOCATION + any change -> output still contains the X-property
- Preserve ATTENDEE: raw with ATTENDEE;CN=John:mailto:john@example.com + any change -> output still has full ATTENDEE with CN parameter
- Increment SEQUENCE: raw with SEQUENCE:0 + any change -> output has SEQUENCE:1
- Refresh DTSTAMP: any change -> output DTSTAMP is updated to current time
- Refresh LAST-MODIFIED: if present in raw, updated to current time
- Change start/end: changes {start: new Date, end: new Date} -> DTSTART and DTEND updated, all other properties preserved
- Undefined fields NOT modified: changes {title: "New"} (no start/end) -> DTSTART and DTEND unchanged
  </behavior>
  <implementation>
**buildICalString implementation:**
1. Import `ICAL` from `ical.js`, `randomUUID` from `node:crypto`, `CreateEventInput` from types
2. Create `ICAL.Component('vcalendar')`, add `version: '2.0'`, `prodid: '-//mcp-twake//EN'`
3. Create `ICAL.Component('vevent')`, add to vcalendar
4. Create `ICAL.Event(vevent)` for convenient setters
5. Set `event.uid = randomUUID()`, `event.summary = input.title`
6. For start/end: if `allDay`, use `ICAL.Time.fromData({year, month, day, isDate: true})`; otherwise use `ICAL.Time.fromJSDate(new Date(input.start), false)` -- the second parameter `false` means local time (not UTC)
7. Set DTSTAMP to `ICAL.Time.now()`
8. Set optional properties via `vevent.updatePropertyWithValue()` for description, location
9. For recurrence: `vevent.addPropertyWithValue('rrule', ICAL.Recur.fromString(input.recurrence))`
10. Return `vcalendar.toString()`

**updateICalString implementation:**
1. Parse raw with `ICAL.parse(raw)` -> `new ICAL.Component(jCalData)`
2. Get vevent: `comp.getFirstSubcomponent('vevent')`
3. For each defined field in changes (check `!== undefined`):
   - title: `vevent.updatePropertyWithValue('summary', changes.title)`
   - start: update DTSTART with new ICAL.Time
   - end: update DTEND with new ICAL.Time
   - description: `vevent.updatePropertyWithValue('description', changes.description)`
   - location: `vevent.updatePropertyWithValue('location', changes.location)`
   - recurrence: update RRULE property
4. Always update DTSTAMP to `ICAL.Time.now()`
5. If LAST-MODIFIED exists, update to `ICAL.Time.now()`
6. Increment SEQUENCE: read current value, parse int, add 1, update
7. Return `comp.toString()` -- this preserves ALL unmodified properties including VALARM, X-props, ATTENDEE

CRITICAL: The parse-modify-serialize pattern via `ICAL.Component.toString()` automatically preserves all properties that were NOT explicitly modified. This is why we NEVER build from scratch during updates.

Note on test file location: Existing tests are in `tests/integration/`. Create `tests/unit/` directory for these pure unit tests. Update vitest.config.ts include pattern if needed (current pattern `tests/**/*.test.ts` already covers subdirectories).
  </implementation>
</feature>

<verification>
1. `npx vitest run tests/unit/event-builder.test.ts` -- all tests pass
2. `npx tsc --noEmit` -- zero compilation errors
3. Build output of `buildICalString` is parseable by `ICAL.parse()` (tested in test suite)
4. Update output of `updateICalString` preserves VALARM, X-properties, ATTENDEE (tested in test suite)
5. `npm test` -- all tests pass (unit + existing integration)
</verification>

<success_criteria>
- buildICalString produces valid iCalendar with all required properties (VERSION, PRODID, UID, DTSTAMP, VEVENT)
- buildICalString handles all-day events with DATE values (not DATE-TIME)
- buildICalString adds RRULE when recurrence parameter supplied
- updateICalString modifies only specified properties, leaving everything else intact
- updateICalString preserves VALARM, X-properties, ATTENDEE with parameters
- updateICalString increments SEQUENCE and refreshes DTSTAMP/LAST-MODIFIED
- All tests pass, TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-write-infrastructure-reverse-transformers/07-02-SUMMARY.md`
</output>
