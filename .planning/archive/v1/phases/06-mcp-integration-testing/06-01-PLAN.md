---
phase: 06-mcp-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - src/server.ts
  - vitest.config.ts
  - tests/integration/tools.test.ts
  - tests/integration/server.test.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Server creation is separated from stdio transport connection"
    - "All 9 MCP tools are registered and discoverable via in-memory transport"
    - "Tool input schemas are valid and match expected structure"
    - "Vitest test suite passes with zero failures"
  artifacts:
    - path: "src/server.ts"
      provides: "Exportable createServer function for testability"
      exports: ["createServer"]
    - path: "src/index.ts"
      provides: "Entry point importing createServer from server.ts"
      contains: "import.*createServer.*from.*server"
    - path: "vitest.config.ts"
      provides: "Vitest configuration for ESM TypeScript"
      contains: "defineConfig"
    - path: "tests/integration/tools.test.ts"
      provides: "Tool registration and schema contract tests"
      contains: "listTools"
    - path: "tests/integration/server.test.ts"
      provides: "Server initialization tests"
      contains: "createServer"
  key_links:
    - from: "tests/integration/tools.test.ts"
      to: "src/server.ts"
      via: "import createServer"
      pattern: "import.*createServer.*from"
    - from: "src/index.ts"
      to: "src/server.ts"
      via: "import createServer for stdio main()"
      pattern: "import.*createServer.*from.*server"
    - from: "tests/integration/tools.test.ts"
      to: "@modelcontextprotocol/sdk"
      via: "InMemoryTransport for in-process testing"
      pattern: "InMemoryTransport"
---

<objective>
Refactor the MCP server for testability and add Vitest integration tests validating protocol contracts.

Purpose: The current src/index.ts has a monolithic main() function that creates everything inline and immediately connects stdio transport. This makes in-memory testing impossible. Extracting server creation into a separate module enables InMemoryTransport-based integration tests that validate tool registration, input schemas, and error formatting without needing a real CalDAV server.

Output: Testable server module (src/server.ts), updated entry point (src/index.ts), Vitest configuration, integration test suite covering all 9 MCP tools.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mcp-integration-testing/06-RESEARCH.md

@src/index.ts
@src/tools/index.ts
@src/config/schema.ts
@src/errors.ts
@src/caldav/client.ts
@src/caldav/calendar-service.ts
@src/caldav/addressbook-service.ts
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract createServer into src/server.ts and update entry point</name>
  <files>src/server.ts, src/index.ts</files>
  <action>
Create a new file `src/server.ts` that exports a `createServer()` function. This function should:

1. Accept dependencies as parameters (CalendarService, AddressBookService, Logger) instead of creating them internally
2. Create the McpServer instance with name 'mcp-twake' and version '0.1.0'
3. Call registerAllTools(server, calendarService, addressBookService, logger)
4. Return the server instance (NOT connect transport — that's the caller's job)

Function signature:
```typescript
export function createServer(
  calendarService: CalendarService,
  addressBookService: AddressBookService,
  logger: Logger
): McpServer
```

Then update `src/index.ts` to:
1. Import createServer from './server.js' (ESM .js extension required)
2. Replace the inline McpServer creation (steps 6-7 in current main()) with a call to createServer()
3. Keep ALL other main() logic unchanged (config loading, client creation, validation, service init)
4. The main() function still handles stdio transport connection after createServer()

The shebang line `#!/usr/bin/env node` MUST remain in src/index.ts (it's the bin entry point).

IMPORTANT: Use .js extensions in all imports (ESM requirement). Do NOT change the overall startup sequence — only extract the McpServer+tool-registration part into server.ts.
  </action>
  <verify>
Run `npx tsc --noEmit` — must compile with zero errors. Verify src/server.ts exports createServer. Verify src/index.ts imports from './server.js' and still has the shebang line.
  </verify>
  <done>
src/server.ts exists with exported createServer function. src/index.ts imports and uses createServer. TypeScript compiles cleanly. Entry point behavior unchanged (same startup sequence).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Vitest and create integration test suite for MCP protocol contracts</name>
  <files>package.json, vitest.config.ts, tests/integration/tools.test.ts, tests/integration/server.test.ts</files>
  <action>
1. Install Vitest as a dev dependency:
   ```
   npm install --save-dev vitest
   ```

2. Create `vitest.config.ts` at project root:
   - Use defineConfig from 'vitest/config'
   - environment: 'node'
   - include: ['tests/**/*.test.ts']
   - testTimeout: 10000 (10s for potential network calls)
   - globals: true

3. Add test script to package.json:
   ```json
   "test": "vitest run",
   "test:watch": "vitest"
   ```

4. Create `tests/integration/server.test.ts`:
   - Test that createServer returns a valid McpServer instance
   - Test that createServer does NOT connect any transport (returns unconnected server)
   - Use mock/stub services (create minimal objects satisfying the interface — they won't be called in registration tests)
   - For the Logger mock, use `{ info: () => {}, debug: () => {}, warn: () => {}, error: () => {}, fatal: () => {}, trace: () => {}, child: () => logger } as unknown as Logger` pattern

5. Create `tests/integration/tools.test.ts`:
   - Import Client from '@modelcontextprotocol/sdk/client/index.js'
   - Import InMemoryTransport from '@modelcontextprotocol/sdk/inMemory.js'
   - Import createServer from '../../src/server.js'
   - Create a test helper that sets up server + client via InMemoryTransport linked pair
   - Test: "should register all 9 tools" — listTools returns exactly 9 tools
   - Test: "should register tools with correct names" — verify exact tool name list: get_next_event, get_todays_schedule, get_events_in_range, search_events, list_calendars, search_contacts, get_contact_details, list_contacts, list_addressbooks
   - Test: "each tool has a description" — every tool.description is a non-empty string
   - Test: "get_next_event has optional calendar_id parameter" — check inputSchema
   - Test: "search_events has required keyword parameter" — check inputSchema

IMPORTANT: The InMemoryTransport import path is `@modelcontextprotocol/sdk/inMemory.js` (check the SDK source if needed — may be at a different path). If the exact import fails, check node_modules/@modelcontextprotocol/sdk/ for the correct export.

IMPORTANT: For McpServer (not Server), you need to access the underlying Server to connect InMemoryTransport. McpServer has a `server` property or a `connect` method. Use `await server.connect(serverTransport)` directly — McpServer supports connect() with any Transport.

For mock services, create objects with the methods that tools call (listCalendars, fetchEvents, listAddressBooks, fetchContacts, etc.) all returning empty arrays. The tools won't actually be called during listTools — only during callTool.
  </action>
  <verify>
Run `npm test` — all tests must pass. Verify output shows test count and pass status. Run `npx tsc --noEmit` to confirm types still valid.
  </verify>
  <done>
Vitest installed, configured, and running. Integration tests verify all 9 tools register correctly with proper names, descriptions, and input schemas. `npm test` exits with code 0.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (no type errors)
2. `npm test` passes (all integration tests green)
3. `node build/index.js` still fails gracefully with missing env vars (entry point behavior unchanged)
4. src/server.ts exports createServer
5. tests/ directory contains working integration tests
</verification>

<success_criteria>
- createServer() extracted and importable from src/server.ts
- src/index.ts uses createServer() without behavior change
- Vitest configured and 5+ integration tests passing
- All 9 MCP tools verified as registered with correct names
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-mcp-integration-testing/06-01-SUMMARY.md`
</output>
