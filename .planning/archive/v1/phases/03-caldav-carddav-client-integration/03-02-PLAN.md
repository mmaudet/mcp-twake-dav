---
phase: 03-caldav-carddav-client-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/caldav/client.ts
  - src/caldav/discovery.ts
autonomous: true

must_haves:
  truths:
    - "A CardDAV client is created alongside the CalDAV client at startup"
    - "Both clients use the same credentials and server URL"
    - "CalDAV client discovers calendars, CardDAV client discovers address books"
    - "Discovery returns typed arrays of DAVCalendar and DAVAddressBook"
    - "Discovery failures are logged with context and re-thrown"
  artifacts:
    - path: "src/caldav/client.ts"
      provides: "createCardDAVClient and createDualClients functions alongside existing createCalDAVClient"
      exports: ["createCalDAVClient", "createCardDAVClient", "createDualClients", "DualClients", "DAVClientType"]
    - path: "src/caldav/discovery.ts"
      provides: "Calendar and addressbook discovery functions"
      exports: ["discoverCalendars", "discoverAddressBooks"]
  key_links:
    - from: "src/caldav/client.ts"
      to: "tsdav createDAVClient"
      via: "createDualClients calls createDAVClient twice with different accountTypes"
      pattern: "defaultAccountType.*caldav.*carddav"
    - from: "src/caldav/discovery.ts"
      to: "src/caldav/client.ts"
      via: "imports DualClients and DAVClientType types"
      pattern: "import.*DualClients.*client\\.js"
    - from: "src/caldav/discovery.ts"
      to: "tsdav fetchCalendars/fetchAddressBooks"
      via: "calls client.fetchCalendars() and client.fetchAddressBooks()"
      pattern: "fetchCalendars|fetchAddressBooks"
---

<objective>
Add CardDAV client creation and build the discovery service for calendars and address books.

Purpose: The current codebase only creates a CalDAV client (`defaultAccountType: 'caldav'`). tsdav requires separate client instances for CalDAV and CardDAV because `defaultAccountType` determines the WebDAV discovery path (`.well-known/caldav` vs `.well-known/carddav`) and home URL resolution (`calendar-home-set` vs `addressbook-home-set`). This plan adds the CardDAV client and wraps tsdav's discovery methods.

Output: Modified `client.ts` with dual-client support and new `discovery.ts` with calendar/addressbook discovery functions.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-caldav-carddav-client-integration/03-RESEARCH.md

@src/caldav/client.ts
@src/config/schema.ts
@src/config/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CardDAV client and dual-client factory to client.ts</name>
  <files>src/caldav/client.ts</files>
  <action>
Modify the existing `src/caldav/client.ts` to add CardDAV client support.

KEEP all existing exports unchanged: `DAVClientType`, `createCalDAVClient`, `validateConnection`. Do NOT break Phase 1 functionality.

ADD the following:

1. Export a `DualClients` interface:
```typescript
export interface DualClients {
  caldav: DAVClientType;
  carddav: DAVClientType;
}
```

2. Export a `createCardDAVClient` function (mirrors `createCalDAVClient` but with `defaultAccountType: 'carddav'`):
```typescript
export function createCardDAVClient(config: Config): Promise<DAVClientType> {
  return createDAVClient({
    serverUrl: config.DAV_URL,
    credentials: {
      username: config.DAV_USERNAME,
      password: config.DAV_PASSWORD,
    },
    authMethod: 'Basic',
    defaultAccountType: 'carddav',
  });
}
```

3. Export a `createDualClients` async function:
```typescript
export async function createDualClients(config: Config, logger: Logger): Promise<DualClients> {
  logger.info({ url: config.DAV_URL }, 'Creating CalDAV and CardDAV clients...');

  const [caldav, carddav] = await Promise.all([
    createCalDAVClient(config),
    createCardDAVClient(config),
  ]);

  logger.info('Both CalDAV and CardDAV clients created successfully');
  return { caldav, carddav };
}
```

This creates both clients in parallel for faster startup.

IMPORTANT: Do NOT modify the existing `validateConnection` function. It will be updated in Plan 05 when wiring everything together. Keep it working as-is for backward compatibility.

Use `.js` extension on all local imports. No console.log.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify existing exports (`DAVClientType`, `createCalDAVClient`, `validateConnection`) are still present.
  </verify>
  <done>
`src/caldav/client.ts` exports DualClients interface, createCardDAVClient function, and createDualClients function. All existing exports preserved. File compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create discovery service for calendars and address books</name>
  <files>src/caldav/discovery.ts</files>
  <action>
Create `src/caldav/discovery.ts`:

Import `type { Logger } from 'pino'`.
Import `type { DAVCalendar, DAVAddressBook } from 'tsdav'`.
Import `type { DAVClientType } from './client.js'`.

Export an async function `discoverCalendars(client: DAVClientType, logger: Logger): Promise<DAVCalendar[]>`:
- Calls `client.fetchCalendars()` to execute PROPFIND on the CalDAV home URL
- Logs at info level: `{ count: calendars.length }`, message "Discovered calendars"
- Also logs each calendar at debug level: `{ url: cal.url, displayName: cal.displayName }`, message "Found calendar"
- Returns the array of DAVCalendar objects
- Wraps in try/catch: on error, logs at error level with `{ err }`, message "Failed to discover calendars", then re-throws

Export an async function `discoverAddressBooks(client: DAVClientType, logger: Logger): Promise<DAVAddressBook[]>`:
- Calls `client.fetchAddressBooks()` to execute PROPFIND on the CardDAV home URL
- Logs at info level: `{ count: addressBooks.length }`, message "Discovered address books"
- Also logs each address book at debug level: `{ url: ab.url, displayName: ab.displayName }`, message "Found address book"
- Returns the array of DAVAddressBook objects
- Wraps in try/catch: on error, logs at error level with `{ err }`, message "Failed to discover address books", then re-throws

NOTE on types: `DAVCalendar` is exported from `tsdav`. `DAVAddressBook` is also exported from `tsdav` (it is an alias for `DAVCollection`). Verify the import works; if `DAVAddressBook` is not directly exported, import `DAVCollection` and create a type alias.

Use `.js` extension on all local imports. No console.log.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify that `discoverCalendars` and `discoverAddressBooks` are exported.
  </verify>
  <done>
`src/caldav/discovery.ts` exports `discoverCalendars` and `discoverAddressBooks` functions. Both accept a DAVClientType and Logger, call the appropriate tsdav discovery method, log results, and return typed arrays. File compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` succeeds with zero errors
2. `src/caldav/client.ts` has all original exports PLUS DualClients, createCardDAVClient, createDualClients
3. `src/caldav/discovery.ts` exports discoverCalendars and discoverAddressBooks
4. createDualClients creates both clients in parallel via Promise.all
5. createCardDAVClient uses `defaultAccountType: 'carddav'` (NOT 'caldav')
6. All imports use `.js` extensions
7. No `console.log` -- logger only
</verification>

<success_criteria>
- Dual-client factory creates CalDAV and CardDAV clients from same credentials
- CardDAV client uses `defaultAccountType: 'carddav'` for correct .well-known discovery
- Discovery functions wrap tsdav's fetchCalendars/fetchAddressBooks with logging
- Existing validateConnection function unchanged (backward compatible)
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-caldav-carddav-client-integration/03-02-SUMMARY.md`
</output>
