---
phase: 05-contact-query-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tools/contacts/utils.ts
autonomous: true

must_haves:
  truths:
    - "searchContactsByName finds contacts by partial, case-insensitive name match across formatted, given, and family name fields"
    - "searchContactsByOrganization finds contacts by partial, case-insensitive organization match"
    - "formatContact produces concise multi-line text with name, emails, phones, organization (no _raw, etag, url, version)"
    - "formatContactSummary produces single-line summary suitable for list views"
    - "getAllContacts transforms raw DAVVCard array into ContactDTO array with null filtering"
  artifacts:
    - path: "src/tools/contacts/utils.ts"
      provides: "Shared contact query utilities (search, format, fetch+transform)"
      exports: ["searchContactsByName", "searchContactsByOrganization", "formatContact", "formatContactSummary", "getAllContacts"]
      min_lines: 80
  key_links:
    - from: "src/tools/contacts/utils.ts"
      to: "src/types/dtos.ts"
      via: "ContactDTO type import"
      pattern: "import.*ContactDTO.*from.*types/dtos"
    - from: "src/tools/contacts/utils.ts"
      to: "src/transformers/contact.ts"
      via: "transformVCard import for getAllContacts"
      pattern: "import.*transformVCard.*from.*transformers/contact"
    - from: "src/tools/contacts/utils.ts"
      to: "src/caldav/addressbook-service.ts"
      via: "AddressBookService type import for getAllContacts"
      pattern: "import.*AddressBookService.*from.*caldav/addressbook-service"
---

<objective>
Create shared contact query utilities for Phase 5 contact MCP tools.

Purpose: Provide reusable search, formatting, and data-fetching functions that all contact tools (CON-01 through CON-04) share. Mirrors Phase 4's src/tools/calendar/utils.ts pattern for DRY contact operations.

Output: src/tools/contacts/utils.ts with 5 exported functions: searchContactsByName, searchContactsByOrganization, formatContact, formatContactSummary, getAllContacts.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-contact-query-services/05-RESEARCH.md

# Source files for implementation reference
@src/tools/calendar/utils.ts       — Phase 4 utils pattern to mirror
@src/types/dtos.ts                  — ContactDTO type definition
@src/transformers/contact.ts        — transformVCard function
@src/caldav/addressbook-service.ts  — AddressBookService type
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contacts directory</name>
  <files>src/tools/contacts/</files>
  <action>
Create the directory src/tools/contacts/ (mkdir -p). This is the new contact tools directory mirroring src/tools/calendar/.
  </action>
  <verify>Directory exists: `ls src/tools/contacts/`</verify>
  <done>src/tools/contacts/ directory exists</done>
</task>

<task type="auto">
  <name>Task 2: Create shared contact query utilities</name>
  <files>src/tools/contacts/utils.ts</files>
  <action>
Create src/tools/contacts/utils.ts with 5 exported functions. Follow the research code examples from 05-RESEARCH.md closely.

**Imports:**
- `ContactDTO` from `../../types/dtos.js`
- `AddressBookService` from `../../caldav/addressbook-service.js` (type-only)
- `transformVCard` from `../../transformers/contact.js`
- `Logger` from `pino` (type-only)

**Function 1: searchContactsByName(contacts: ContactDTO[], query: string): ContactDTO[]**
- Case-insensitive partial match using `toLowerCase().includes()`
- Search across 3 fields: `name.formatted`, `name.given`, `name.family`
- Return contacts where ANY name field matches
- Handle optional fields gracefully (use `?.` optional chaining)

**Function 2: searchContactsByOrganization(contacts: ContactDTO[], query: string): ContactDTO[]**
- Case-insensitive partial match on `contact.organization`
- Use `?.toLowerCase().includes(lowerQuery) ?? false` for null safety

**Function 3: formatContact(contact: ContactDTO): string**
- Multi-line format for detailed view
- Line 1: Display name (prefer `name.formatted`, fallback to "given family", fallback to "(No name)")
- Line 2+: Emails (indented with "  Email: "), only if emails array non-empty
- Lines: Phones (indented with "  Phone: "), only if phones array non-empty
- Line: Organization (indented with "  Organization: "), only if present
- Omit: uid, url, etag, _raw, version (LLM-optimized, no internal metadata)

**Function 4: formatContactSummary(contact: ContactDTO): string**
- Single-line format for list views
- Pattern: "Name <first-email> - Organization"
- Omit email part if no emails, omit org part if no organization

**Function 5: getAllContacts(addressBookService: AddressBookService, logger: Logger): Promise<ContactDTO[]>**
- Call `addressBookService.fetchAllContacts()` to get raw DAVVCards
- Map through `transformVCard(vcard, logger)` for each
- Filter out null results (parse failures) with type guard `(c): c is ContactDTO => c !== null`
- Log count of transformed contacts
- Return ContactDTO array

All functions must use ESM imports with .js extensions. JSDoc comments on all functions following Phase 4 patterns.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Zero type errors related to src/tools/contacts/utils.ts. Verify the file exports all 5 functions by checking the export statements.
  </verify>
  <done>
src/tools/contacts/utils.ts exists with 5 exported functions (searchContactsByName, searchContactsByOrganization, formatContact, formatContactSummary, getAllContacts). TypeScript compiles with no errors. Functions handle case-insensitive search, missing fields gracefully, and exclude internal metadata from formatted output.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors related to contacts/utils.ts
2. File exports exactly 5 functions: searchContactsByName, searchContactsByOrganization, formatContact, formatContactSummary, getAllContacts
3. No internal metadata (uid, url, etag, _raw, version) appears in formatContact or formatContactSummary output
4. All imports use .js extensions (ESM)
</verification>

<success_criteria>
- src/tools/contacts/utils.ts compiles cleanly
- 5 functions exported: searchContactsByName, searchContactsByOrganization, formatContact, formatContactSummary, getAllContacts
- Case-insensitive search across formatted/given/family name fields
- Organization search on contact.organization field
- LLM-optimized formatting (no _raw, etag, url, version in output)
- Missing fields handled gracefully (no "undefined" in output)
</success_criteria>

<output>
After completion, create `.planning/phases/05-contact-query-services/05-01-SUMMARY.md`
</output>
