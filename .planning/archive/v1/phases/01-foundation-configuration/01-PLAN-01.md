---
phase: 01-foundation-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - .env.example
  - .gitignore
  - src/config/schema.ts
  - src/config/logger.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript project compiles without errors"
    - "Environment variables validated at import time with Zod (fail-fast)"
    - "HTTP URLs rejected with clear error (HTTPS required except localhost)"
    - "Logger writes exclusively to stderr (file descriptor 2), never stdout"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with all Phase 1 dependencies"
      contains: "@modelcontextprotocol/sdk"
    - path: "tsconfig.json"
      provides: "TypeScript compilation configuration"
      contains: "compilerOptions"
    - path: "src/config/schema.ts"
      provides: "Zod environment variable validation with HTTPS enforcement"
      exports: ["envSchema", "config", "Config"]
    - path: "src/config/logger.ts"
      provides: "Pino logger configured to stderr only"
      exports: ["logger"]
    - path: "src/types/index.ts"
      provides: "Shared TypeScript type definitions"
  key_links:
    - from: "src/config/schema.ts"
      to: "process.env"
      via: "Zod parse at import time"
      pattern: "envSchema\\.parse\\(process\\.env\\)"
    - from: "src/config/logger.ts"
      to: "stderr"
      via: "pino.destination(2)"
      pattern: "pino\\.destination\\(2\\)"
---

<objective>
Scaffold the TypeScript project and implement configuration validation with stderr-only logging.

Purpose: Establish the project foundation with fail-fast configuration validation and safe logging that prevents stdout contamination -- the two most critical pitfalls for MCP stdio servers.

Output: A compilable TypeScript project with validated environment variables (Zod), HTTPS enforcement (localhost exception), and Pino logger writing exclusively to stderr.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-configuration/01-RESEARCH.md
@.planning/phases/01-foundation-configuration/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold TypeScript project with dependencies</name>
  <files>
    package.json
    tsconfig.json
    .env.example
    .gitignore
  </files>
  <action>
    Initialize the project:

    1. Create `package.json` with:
       - name: "mcp-twake"
       - version: "0.1.0"
       - description: "MCP server for CalDAV/CardDAV calendars and contacts"
       - license: "AGPL-3.0"
       - type: "module" (ESM -- required by MCP SDK)
       - main: "build/index.js"
       - bin: { "mcp-twake": "build/index.js" }
       - scripts:
         - "build": "tsc"
         - "start": "node build/index.js"
         - "dev": "tsc --watch"
       - engines: { "node": ">=18.0.0" }

    2. Install runtime dependencies:
       `npm install @modelcontextprotocol/sdk zod pino tsdav`

    3. Install dev dependencies:
       `npm install -D typescript @types/node`

    4. Create `tsconfig.json`:
       - target: "ES2022"
       - module: "Node16"
       - moduleResolution: "Node16"
       - outDir: "./build"
       - rootDir: "./src"
       - strict: true
       - esModuleInterop: true
       - skipLibCheck: true
       - forceConsistentCasingInFileNames: true
       - declaration: true
       - sourceMap: true

    5. Create `.env.example`:
       ```
       DAV_URL=https://dav.example.com
       DAV_USERNAME=your_username
       DAV_PASSWORD=your_password
       LOG_LEVEL=info
       ```

    6. Create/update `.gitignore`:
       - node_modules/
       - build/
       - .env
       - *.js.map (in build dir, but covered by build/)

    7. Create empty directory structure:
       - src/config/
       - src/caldav/
       - src/tools/
       - src/types/

    IMPORTANT: Use "type": "module" in package.json. The MCP SDK uses ESM imports with .js extensions (e.g., `@modelcontextprotocol/sdk/server/mcp.js`).
  </action>
  <verify>
    - `npm ls` shows all 4 runtime dependencies installed without errors
    - `npx tsc --noEmit` succeeds (once source files exist -- verify after Task 2)
    - `.env.example` contains DAV_URL, DAV_USERNAME, DAV_PASSWORD
    - `.gitignore` includes node_modules/, build/, .env
  </verify>
  <done>
    package.json exists with all dependencies, tsconfig.json configured for ESM output, .env.example documents required variables, .gitignore prevents secrets and build artifacts from being committed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement configuration validation and stderr logger</name>
  <files>
    src/config/schema.ts
    src/config/logger.ts
    src/types/index.ts
  </files>
  <action>
    1. Create `src/types/index.ts`:
       - Export a `Config` type with:
         - davUrl: string
         - davUsername: string
         - davPassword: string
         - logLevel: string

    2. Create `src/config/schema.ts`:
       - Import `z` from 'zod'
       - Define `envSchema` as a Zod object:
         - `DAV_URL`: z.string().url() with a `.refine()` that:
           - Parses with `new URL(url)`
           - Returns `true` if protocol is `https:` OR hostname is `localhost` OR hostname is `127.0.0.1`
           - Error message: `"URL must use HTTPS. Only localhost is allowed over HTTP for development."`
         - `DAV_USERNAME`: z.string().min(1, "DAV_USERNAME is required")
         - `DAV_PASSWORD`: z.string().min(1, "DAV_PASSWORD is required")
         - `LOG_LEVEL`: z.enum(['fatal', 'error', 'warn', 'info', 'debug', 'trace']).default('info')
       - Parse immediately: `export const config = envSchema.parse(process.env);`
         NOTE: Do NOT parse at import time in this file. Instead, export a `loadConfig()` function that parses and returns the config. This allows the entry point to catch Zod errors gracefully and display AI-friendly messages before exiting.
         ```typescript
         export function loadConfig() {
           return envSchema.parse(process.env);
         }
         ```
       - Export the Zod schema, the function, and the inferred type:
         ```typescript
         export type Config = z.infer<typeof envSchema>;
         ```

    3. Create `src/config/logger.ts`:
       - Import `pino` from 'pino'
       - Create and export a `createLogger` function that accepts a log level string:
         ```typescript
         export function createLogger(level: string = 'info') {
           return pino(
             {
               name: 'mcp-twake',
               level,
             },
             pino.destination(2)  // CRITICAL: fd 2 = stderr. NEVER use stdout.
           );
         }
         ```
       - Export the Logger type: `export type Logger = pino.Logger;`
       - CRITICAL: The logger MUST use `pino.destination(2)` (stderr). Do NOT use the default pino destination (stdout). stdout is reserved for MCP stdio JSON-RPC protocol messages.

    4. Verify TypeScript compiles:
       Run `npx tsc --noEmit` and fix any type errors.

    IMPORTANT NOTES:
    - Use `.js` extensions in relative imports (ESM requirement): `import { Config } from '../types/index.js'`
    - The `loadConfig()` pattern (not top-level parse) is intentional -- it allows main() to catch ZodError and format user-friendly messages.
    - The `createLogger()` factory pattern allows config to control log level.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `src/config/schema.ts` exports `envSchema`, `loadConfig`, and `Config` type
    - `src/config/logger.ts` exports `createLogger` function using `pino.destination(2)`
    - Grep confirms NO use of `console.log`, `process.stdout`, or default pino() in source files
  </verify>
  <done>
    Zod schema validates DAV_URL (HTTPS required, localhost exception), DAV_USERNAME, DAV_PASSWORD at startup. Logger factory creates Pino instances writing to stderr only. TypeScript compiles cleanly with strict mode.
  </done>
</task>

</tasks>

<verification>
1. `npm ls` confirms @modelcontextprotocol/sdk, zod, pino, tsdav installed
2. `npx tsc --noEmit` compiles without errors
3. `grep -r "console.log\|process.stdout" src/` returns no results (no stdout contamination)
4. `grep "pino.destination(2)" src/config/logger.ts` confirms stderr destination
5. `grep "refine" src/config/schema.ts` confirms HTTPS enforcement with URL refinement
</verification>

<success_criteria>
- TypeScript project compiles with zero errors
- All 4 runtime dependencies installed (@modelcontextprotocol/sdk, zod, pino, tsdav)
- Zod schema rejects `http://example.com` but accepts `https://example.com` and `http://localhost:8080`
- Pino logger writes to stderr (fd 2), never stdout
- No `console.log` or `process.stdout.write` in any source file
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-configuration/01-01-SUMMARY.md`
</output>
